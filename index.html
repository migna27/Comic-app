<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio de Creación de Cómics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@700&family=Creepster&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal/dist/bundle.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .tag { transition: all 0.2s ease-in-out; }
        .tag:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .panel-generating::after, .modal-generating::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); border-radius: 0.5rem; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .modal-generating::after { content: 'Generando...'; color: white; font-weight: bold; }
        #comic-preview-container { position: relative; }
        #comic-preview { background-color: transparent; }
        .comic-panel { border: 2px solid #4b5563; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background-color: #e5e7eb; position: relative; transition: box-shadow 0.2s, border-color 0.2s; }
        .comic-panel .panel-actions { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s ease-in-out; display: flex; gap: 4px; z-index: 20; }
        .comic-panel:hover .panel-actions { opacity: 1; }
        .comic-panel.selected-panel { border-color: #38bdf8; box-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
        .panel-card.selected-panel { border-color: #38bdf8 !important; }

        .asset-tag, .page-thumb { background-size: cover; background-position: center; position: relative; }
        .asset-tag .overlay, .page-thumb .overlay { background-color: rgba(0,0,0,0.6); transition: background-color 0.3s; }
        .asset-tag:hover .overlay, .page-thumb:hover .overlay { background-color: rgba(0,0,0,0.3); }
        .ref-image-thumb { position: relative; }
        .ref-image-thumb button { position: absolute; top: -5px; right: -5px; background-color: rgba(239, 68, 68, 0.8); border-radius: 9999px; padding: 2px; display: none; }
        .ref-image-thumb:hover button { display: block; }
        .panel-card.dragging, .page-thumb.dragging { opacity: 0.4; }
        .drop-placeholder { background-color: rgba(75, 85, 99, 0.5); border: 2px dashed #6366f1; border-radius: 0.5rem; }
        body.presentation-mode #control-panel, body.presentation-mode #main-header { display: none; }
        body.presentation-mode #main-content { width: 100%; height: 100vh; }
        .text-overlay-element { position: absolute; cursor: grab; border: 2px dashed transparent; transition: border-color 0.2s; }
        .text-overlay-element:hover, .text-overlay-element.selected { border-color: #3b82f6; z-index: 50 !important; }
        .text-overlay-element.dragging { cursor: grabbing; }
        .speech-bubble { background: white; color: black; border-radius: 10px; padding: 10px; border: 2px solid black; font-family: 'Comic Neue', cursive; min-width: 50px; min-height: 30px; }
        .thought-bubble { background: white; color: black; border-radius: 50%; padding: 15px; border: 2px solid black; font-family: 'Comic Neue', cursive; }
        .scream-bubble { background: white; color: black; border: 2px solid black; font-family: 'Bangers', cursive; font-size: 1.2em; padding: 10px; clip-path: polygon(0% 0%, 100% 5%, 95% 100%, 5% 95%); }
        .sfx-style-1 { font-family: 'Bangers', cursive; font-size: 3em; color: #ffeb3b; text-shadow: 3px 3px 0px #e91e63; }
        .sfx-style-2 { font-family: 'Creepster', cursive; font-size: 3.5em; color: #4caf50; text-shadow: 2px 2px 0px #ffffff; }
        .sfx-style-3 { font-family: 'Comic Neue', cursive; font-size: 2.8em; color: #2196f3; text-shadow: -2px 2px 0px #ff9800; transform: skew(-15deg); }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        .framing-controls { position: absolute; bottom: 8px; left: 8px; right: 8px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 6px; z-index: 25; display: flex; flex-direction: column; gap: 4px; backdrop-filter: blur(4px); }
        .framing-controls label { font-size: 10px; color: white; display: flex; align-items: center; gap: 4px; }
        .framing-controls input[type="range"] { flex-grow: 1; height: 4px; -webkit-appearance: none; background: #4a5568; outline: none; border-radius: 2px; }
        .framing-controls input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: #a78bfa; cursor: pointer; border-radius: 50%; }
        .overlay-opacity-slider { height: 4px !important; } .overlay-opacity-slider::-webkit-slider-thumb { height: 12px !important; width: 12px !important; background: #f59e0b !important; }

        /* --- Panel Shapes --- */
        .panel-shape-rectangle { clip-path: none; }
        .panel-shape-diagonal { clip-path: polygon(0 0, 100% 10%, 100% 100%, 0 90%); }
        .panel-shape-trapezoid { clip-path: polygon(15% 0, 85% 0, 100% 100%, 0% 100%); }
        .panel-shape-banner { clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 85% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 85% 100%, 15% 100%, 15% 85%, 0% 85%); }
        .panel-shape-circle { clip-path: circle(50% at 50% 50%); }
        .panel-shape-burst { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .panel-shape-hexagon { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
        .panel-shape-diamond { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }

        /* --- Auto Layout Styles --- */
        .layout-option-btn.active img { border-color: #6366f1; }
        #comic-preview.layout { display: grid; gap: 16px; align-content: start; }
        #comic-preview.layout-default { grid-template-columns: repeat(6, 1fr); align-items: stretch; }
        
        #comic-preview.layout-dynamic-5 { grid-template-columns: repeat(6, 1fr); grid-template-rows: auto; grid-template-areas: "p1 p1 p1 p2 p2 p2" "p3 p3 p3 p3 p3 p3" "p4 p4 p4 p5 p5 p5"; }
        #comic-preview.layout-dynamic-5 .comic-panel:nth-of-type(1) { grid-area: p1; }
        #comic-preview.layout-dynamic-5 .comic-panel:nth-of-type(2) { grid-area: p2; }
        #comic-preview.layout-dynamic-5 .comic-panel:nth-of-type(3) { grid-area: p3; }
        #comic-preview.layout-dynamic-5 .comic-panel:nth-of-type(4) { grid-area: p4; }
        #comic-preview.layout-dynamic-5 .comic-panel:nth-of-type(5) { grid-area: p5; }

        #comic-preview.layout-hero-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: auto; grid-template-areas: "h h" "s1 s2" "s3 s3"; }
        #comic-preview.layout-hero-4 .comic-panel:nth-of-type(1) { grid-area: h; }
        #comic-preview.layout-hero-4 .comic-panel:nth-of-type(2) { grid-area: s1; }
        #comic-preview.layout-hero-4 .comic-panel:nth-of-type(3) { grid-area: s2; }
        #comic-preview.layout-hero-4 .comic-panel:nth-of-type(4) { grid-area: s3; }

        #comic-preview.layout-classic-6 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, auto); }
        #comic-preview.layout-webtoon { display: flex; flex-direction: column; }

        /* --- Overlay Panels --- */
        #overlay-panel-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        .overlay-panel { position: absolute; border: 2px solid #6366f1; box-shadow: 0 6px 12px rgba(0,0,0,0.4); pointer-events: auto; cursor: grab; background-color: #4b5563; overflow: hidden; }
        .overlay-panel.selected { border-color: #f59e0b; z-index: 100 !important; }
        .overlay-panel.dragging { cursor: grabbing; }
        .overlay-panel .resizer { position: absolute; width: 14px; height: 14px; background: #f59e0b; border: 2px solid white; border-radius: 2px; bottom: -7px; right: -7px; cursor: se-resize; z-index: 101; pointer-events: auto; }
        .overlay-panel .panel-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; z-index: 20; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="restore-prompt" class="hidden fixed top-0 left-0 right-0 bg-indigo-600 text-white p-3 text-center z-[100] flex justify-center items-center gap-4 shadow-lg">
        <p>Se encontró un proyecto autoguardado. ¿Deseas restaurarlo?</p>
        <button id="restore-btn" class="bg-white text-indigo-700 font-bold py-1 px-3 rounded-md hover:bg-indigo-100">Restaurar</button>
        <button id="discard-restore-btn" class="bg-transparent border border-white font-bold py-1 px-3 rounded-md hover:bg-indigo-700">Descartar</button>
    </div>
    <div id="app" class="flex flex-col md:flex-row h-screen">
        <aside id="control-panel" class="w-full md:w-1/3 xl:w-1/4 p-4 bg-gray-900 border-r border-gray-700 flex flex-col space-y-4 overflow-y-auto">
            <header class="text-center relative">
                <div class="absolute top-0 left-0">
                    <div id="file-menu" class="relative">
                        <button id="file-menu-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-lg"><i data-lucide="file" class="w-5 h-5"></i></button>
                        <div id="file-dropdown" class="absolute left-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg hidden z-20">
                            <button id="save-project-btn" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 flex items-center"><i data-lucide="save" class="w-4 h-4 mr-2"></i>Guardar Proyecto</button>
                            <button id="load-project-btn" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 flex items-center"><i data-lucide="folder-open" class="w-4 h-4 mr-2"></i>Cargar Proyecto</button>
                            <button id="backup-project-btn" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 flex items-center"><i data-lucide="archive" class="w-4 h-4 mr-2"></i>Descargar Respaldo</button>
                            <input type="file" id="load-project-input" class="hidden" accept=".comicproject">
                        </div>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-white">Estudio de Cómics</h1>
                <p class="text-sm text-gray-400">Tu historia, tu control.</p>
            </header>
            
            <div class="border-b border-gray-700">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="tab-creation" class="tab-btn active whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500">Creación</button>
                    <button id="tab-script" class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500">Guion</button>
                </nav>
            </div>

            <div id="creation-panel" class="flex flex-col space-y-4">
                 <section id="pages-section">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Páginas</h2>
                        <button id="add-page-btn" class="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>Añadir</span></button>
                    </div>
                    <div id="pages-list" class="flex flex-nowrap gap-3 p-2 bg-gray-800 rounded-lg min-h-[80px] overflow-x-auto"></div>
                </section>
                <section id="characters-section">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Personajes</h2>
                        <button id="add-character-btn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>Añadir</span></button>
                    </div>
                    <div id="characters-list" class="flex flex-wrap gap-2 p-2 bg-gray-800 rounded-lg min-h-[40px]"><p id="no-characters-msg" class="text-gray-500 text-sm w-full">Añade tu primer personaje.</p></div>
                </section>
                <section id="backgrounds-section">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Fondos</h2>
                        <button id="add-background-btn" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>Añadir</span></button>
                    </div>
                    <div id="backgrounds-list" class="grid grid-cols-2 gap-2 p-2 bg-gray-800 rounded-lg min-h-[40px]"><p id="no-backgrounds-msg" class="text-gray-500 text-sm w-full col-span-2">Añade tu primer fondo.</p></div>
                </section>
                 <section id="poses-section">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Poses y Objetos</h2>
                        <button id="add-pose-btn" class="flex items-center space-x-2 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>Añadir</span></button>
                    </div>
                    <div id="poses-list" class="grid grid-cols-3 gap-2 p-2 bg-gray-800 rounded-lg min-h-[40px]"><p id="no-poses-msg" class="text-gray-500 text-sm w-full col-span-3">Añade tu primera pose/objeto.</p></div>
                </section>
                <section id="clothing-section">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-white">Ropa y Accesorios</h2>
                        <button id="add-clothing-btn" class="flex items-center space-x-2 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i><span>Añadir</span></button>
                    </div>
                    <div id="clothing-list" class="grid grid-cols-3 gap-2 p-2 bg-gray-800 rounded-lg min-h-[40px]"><p id="no-clothing-msg" class="text-gray-500 text-sm w-full col-span-3">Añade tu primera prenda.</p></div>
                </section>
                <section id="storyboard-section" class="flex-grow flex flex-col">
                    <h2 class="text-lg font-semibold text-white mb-2">Viñetas de la Página</h2>
                    <div id="panels-list" class="flex-grow space-y-4 overflow-y-auto pr-2"><p id="no-panels-msg" class="text-gray-500 text-sm p-4 text-center bg-gray-800 rounded-lg">Tu página está vacía.</p></div>
                     <button id="add-panel-btn" class="w-full mt-4 flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i><span>Añadir Viñeta</span></button>
                </section>
                <section id="overlay-storyboard-section" class="flex-grow flex flex-col mt-4 border-t border-gray-700 pt-4">
                    <h2 class="text-lg font-semibold text-white mb-2">Capas de Viñetas</h2>
                    <div id="overlay-panels-list" class="flex-grow space-y-4 overflow-y-auto pr-2"><p id="no-overlay-panels-msg" class="text-gray-500 text-sm p-4 text-center bg-gray-800 rounded-lg">Sin viñetas superpuestas.</p></div>
                </section>
            </div>
            <div id="script-panel" class="hidden flex-grow flex flex-col space-y-4">
                 <h2 class="text-lg font-semibold text-white mb-2">Editor de Guion</h2>
                 <textarea id="script-editor" class="w-full h-full flex-grow bg-gray-800 rounded-md p-2 text-sm" placeholder="Escribe o pega tu guion aquí...&#10;Ejemplo:&#10;[PÁGINA 1]&#10;[VIÑETA 1]&#10;FONDO: Bosque Nocturno&#10;PERSONAJE: Kaelen (serio)&#10;PROMPT: Kaelen mira a la luna, pensativo.&#10;DIALOGO (Kaelen): No hay vuelta atrás."></textarea>
                 <button id="import-script-btn" class="w-full mt-4 flex items-center justify-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="file-up" class="w-5 h-5"></i><span>Importar Guion al Storyboard</span></button>
            </div>
        </aside>

        <!-- Previsualización del Cómic -->
        <main id="main-content" class="w-full md:w-2/3 xl:w-3/4 bg-gray-800 flex flex-col p-4">
             <div id="main-header" class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-4">
                    <h2 class="text-lg font-semibold text-white">Página <span id="current-page-number">1</span></h2>
                    <div class="flex items-center space-x-2">
                        <label for="page-bg-color" class="text-sm text-gray-400">Fondo:</label>
                        <input type="color" id="page-bg-color" value="#FFFFFF" class="w-8 h-8 p-0 border-none rounded-md cursor-pointer bg-transparent">
                    </div>
                    <span id="autosave-status" class="text-sm text-gray-500 transition-opacity duration-500 opacity-0"></span>
                </div>
                 <div id="text-layer-controls" class="hidden items-center space-x-2 bg-gray-900/50 p-2 rounded-lg">
                    <button id="delete-text-btn" title="Eliminar Texto" class="p-1 hover:bg-red-700 rounded-md"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                    <button id="send-back-btn" title="Enviar al fondo" class="p-1 hover:bg-gray-700 rounded-md"><i data-lucide="chevrons-down-up" class="w-5 h-5 pointer-events-none"></i></button>
                    <button id="bring-front-btn" title="Traer al frente" class="p-1 hover:bg-gray-700 rounded-md"><i data-lucide="chevrons-up-down" class="w-5 h-5 pointer-events-none"></i></button>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="add-overlay-panel-btn" title="Añadir Capa de Viñeta" class="flex items-center space-x-2 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="layers" class="w-5 h-5"></i></button>
                    <button id="add-dialogue-btn" title="Añadir Diálogo" class="flex items-center space-x-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="message-square" class="w-5 h-5"></i></button>
                    <button id="add-sfx-btn" title="Añadir Onomatopeya" class="flex items-center space-x-2 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="zap" class="w-5 h-5"></i></button>
                    <div class="relative">
                        <button id="auto-layout-btn" title="Diseño Automático" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="layout-template" class="w-5 h-5"></i></button>
                        <div id="layout-popover" class="hidden absolute right-0 mt-2 w-56 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-30 p-2 animate-fade-in">
                            <h4 class="text-sm font-semibold text-gray-300 px-2 pb-2">Maquetación Automática</h4>
                            <div class="grid grid-cols-2 gap-2 text-center">
                                <button class="layout-option-btn" data-layout="default"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxRjI5MzciLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iNDIiIGhlaWdodD0iMzIiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iNTAiIHk9IjgiIHdpZHRoPSI0MiIgaGVpZHRoPSIzMiIgcng9IjIiIGZpbGw9IiM0QjU1NjMiLz48cmVjdCB4PSI4IiB5PSI0MCIgd2lkdGg9IjQyIiBoZWlnaHQ9IjMyIiByeD0iMiIgZmlsbD0iIzRCNTU2MyIvPjwvc3ZnPg==" class="w-full h-auto rounded-md border-2 border-transparent hover:border-indigo-500"><span class="text-xs mt-1 block">Grid Básico</span></button>
                                <button class="layout-option-btn" data-layout="dynamic-5"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxRjI5MzciLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iNDIiIGhlaWdodD0iMjIiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iNTAiIHk9IjgiIHdpZHRoPSI0MiIgaGVpZ2h0PSIyMiIgcng9IjIiIGZpbGw9IiM0QjU1NjMiLz48cmVjdCB4PSI4IiB5PSIzMCIgd2lkdGg9Ijg0IiBoZWlnaHQ9IjE4IiByeD0iMiIgZmlsbD0iIzRCNTU2MyIvPjxyZWN0IHg9IjgiIHk9IjQ4IiB3aWR0aD0iNDIiIGhlaWdodD0iMjQiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iNTAiIHk9IjQ4IiB3aWR0aD0iNDIiIGhlaWdodD0iMjQiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PC9zdmc+" class="w-full h-auto rounded-md border-2 border-transparent hover:border-indigo-500"><span class="text-xs mt-1 block">Dinámico (5)</span></button>
                                <button class="layout-option-btn" data-layout="hero-4"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxRjI5MzciLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iODQiIGhlaWdodD0iMzIiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iOCIgeT0iNDAiIHdpZHRoPSI0MiIgaGVpZ2h0PSIyNCIgcng9IjIiIGZpbGw9IiM0QjU1NjMiLz48cmVjdCB4PSI1MCIgeT0iNDAiIHdpZHRoPSI0MiIgaGVpZ2h0PSIyNCIgcng9IjIiIGZpbGw=IiM0QjU1NjMiLz48cmVjdCB4PSI4IiB5PSI2NCIgd2lkdGg9Ijg0IiBoZWlnaHQ9IjgiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PC9zdmc+" class="w-full h-auto rounded-md border-2 border-transparent hover:border-indigo-500"><span class="text-xs mt-1 block">Héroe (4)</span></button>
                                <button class="layout-option-btn" data-layout="classic-6"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxRjI5MzciLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iNDIiIGhlaWdodD0iMjIiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iNTAiIHk9IjgiIHdpZHRoPSI0MiIgaGVpZ2h0PSIyMiIgcng9IjIiIGZpbGw=IiM0QjU1NjMiLz48cmVjdCB4PSI4IiB5PSIzMCIgd2lkdGg9IjQyIiBoZWlnaHQ9IjIyIiByeD0iMiIgZmlsbD0iIzRCNTU2MyIvPjxyZWN0IHg9IjUwIiB5PSIzMCIgd2lkdGg9IjQyIiBoZWlnaHQ9IjIyIiByeD0iMiIgZmlsbD0iIzRCNTU2MyIvPjxyZWN0IHg9IjgiIHk9IjUyIiB3aWR0aD0iNDIiIGhlaWdodD0iMjAiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iNTAiIHk9IjUyIiB3aWR0aD0iNDIiIGhlaWdodD0iMjAiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PC9zdmc+" class="w-full h-auto rounded-md border-2 border-transparent hover:border-indigo-500"><span class="text-xs mt-1 block">Clásico (6)</span></button>
                                <button class="layout-option-btn col-span-2" data-layout="webtoon"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTAwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iODAiIGZpbGw9IiMxRjI5MzciLz48cmVjdCB4PSI4IiB5PSI4IiB3aWR0aD0iODQiIGhlaWdodD0iMjAiIHJ4PSIyIiBmaWxsPSIjNEI1NTYzIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4NCIgaGVpZ2h0PSIyMCIgcng9IjIiIGZpbGw9IiM0QjU1NjMiLz48cmVjdCB4PSI4IiB5PSI1MiIgd2lkdGg9Ijg0IiBoZWlnaHQ9IjIwIiByeD0iMiIgZmlsbD0iIzRCNTU2MyIvPjwvc3ZnPg==" class="w-full h-auto rounded-md border-2 border-transparent hover:border-indigo-500"><span class="text-xs mt-1 block">Webtoon (Vertical)</span></button>
                            </div>
                        </div>
                    </div>
                    <button id="export-pdf-btn" title="Exportar a PDF" class="flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                    <button id="download-panels-btn" title="Descargar Viñetas (ZIP)" class="flex items-center space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="archive" class="w-5 h-5"></i></button>
                    <button id="download-all-pages-btn" title="Descargar Todas las Páginas (ZIP)" class="flex items-center space-x-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="folder-down" class="w-5 h-5"></i></button>
                    <button id="download-comic-btn" title="Descargar Página Actual (PNG)" class="flex items-center space-x-2 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="download" class="w-5 h-5"></i></button>
                    <button id="export-webtoon-btn" title="Exportar para Webtoon" class="flex items-center space-x-2 bg-green-800 hover:bg-green-900 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="file-down" class="w-5 h-5"></i></button>
                    <button id="presentation-mode-btn" title="Modo Presentación" class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"><i data-lucide="fullscreen" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="comic-preview-container" class="w-full h-full bg-white rounded-lg shadow-inner p-4 overflow-auto">
                <div id="comic-preview" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div id="preview-placeholder" class="col-span-full h-full min-h-[60vh] flex flex-col justify-center items-center text-gray-500"><i data-lucide="layout-grid" class="w-24 h-24 mb-4"></i><p class="text-lg">Tu página de cómic aparecerá aquí.</p></div>
                </div>
                <div id="overlay-panel-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                <div id="text-overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="character-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="background-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="clothing-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="pose-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="edit-panel-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="dialogue-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="sfx-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50"></div>
    <div id="character-card-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4"></div>
    
    <input type="file" class="hidden" id="panel-image-upload" accept="image/*">
    <input type="file" class="hidden" id="layer-image-upload" accept="image/*">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            lucide.createIcons();

            // --- STATE ---
            let project = {
                pages: [{ id: 1, panels: [], overlayPanels: [], texts: [], layout: 'default', backgroundColor: '#ffffff' }],
                characters: [],
                backgrounds: [],
                clothing: [],
                poses: []
            };
            let activePageIndex = 0;
            let nextId = { character: 1, background: 1, clothing: 1, pose: 1, panel: 1, page: 2, text: 1, overlayPanel: 1 };
            let tempImages = [];
            let editedImageUrl = null;
            let currentlyEditingPanelId = null;
            let cropper = null;
            let currentlyEditingTextId = null;
            let selectedTextElement = null;
            let selectedPanelId = null;
            let selectedOverlayPanelId = null;
            let currentlyUploadingToLayerId = null;
            let currentlyUploadingToPanelId = null;

            // --- DOM REFS ---
            const getEl = (id) => document.getElementById(id);
            const charactersList = getEl('characters-list'), backgroundsList = getEl('backgrounds-list'), clothingList = getEl('clothing-list'), posesList = getEl('poses-list'), panelsList = getEl('panels-list'), pagesList = getEl('pages-list'), overlayPanelsList = getEl('overlay-panels-list');
            const comicPreview = getEl('comic-preview'), comicPreviewContainer = getEl('comic-preview-container'), overlayPanelLayer = getEl('overlay-panel-layer');
            const characterModal = getEl('character-modal'), backgroundModal = getEl('background-modal'), clothingModal = getEl('clothing-modal'), poseModal = getEl('pose-modal'), editPanelModal = getEl('edit-panel-modal');
            const dialogueModal = getEl('dialogue-modal'), sfxModal = getEl('sfx-modal');
            const downloadComicBtn = getEl('download-comic-btn'), addPanelBtn = getEl('add-panel-btn'), addPageBtn = getEl('add-page-btn');
            const downloadPanelsBtn = getEl('download-panels-btn'), downloadAllPagesBtn = getEl('download-all-pages-btn');
            const noCharactersMsg = getEl('no-characters-msg'), noBackgroundsMsg = getEl('no-backgrounds-msg'), noClothingMsg = getEl('no-clothing-msg'), noPosesMsg = getEl('no-poses-msg'), noPanelsMsg = getEl('no-panels-msg'), noOverlayPanelsMsg = getEl('no-overlay-panels-msg');
            const previewPlaceholder = getEl('preview-placeholder');
            const currentPageNumber = getEl('current-page-number');
            const pageBgColorPicker = getEl('page-bg-color');
            const textOverlay = getEl('text-overlay');
            const textLayerControls = getEl('text-layer-controls');
            const autoLayoutBtn = getEl('auto-layout-btn');
            const layoutPopover = getEl('layout-popover');

            // --- DB HELPER ---
            const db = {
                _db: null,
                async open() {
                    if (this._db) return this._db;
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('ComicStudioDB', 1);
                        request.onerror = (event) => reject("Error al abrir IndexedDB: " + request.error);
                        request.onsuccess = (event) => {
                            this._db = request.result;
                            resolve(this._db);
                        };
                        request.onupgradeneeded = (event) => {
                            const dbInstance = event.target.result;
                            dbInstance.createObjectStore('projects', { keyPath: 'id' });
                        };
                    });
                },
                async saveProject(id, data) {
                    if (!this._db) await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this._db.transaction(['projects'], 'readwrite');
                        const store = transaction.objectStore('projects');
                        const request = store.put({ id, ...data });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                },
                async getProject(id) {
                    if (!this._db) await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this._db.transaction(['projects'], 'readonly');
                        const store = transaction.objectStore('projects');
                        const request = store.get(id);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                async deleteProject(id) {
                    if (!this._db) await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this._db.transaction(['projects'], 'readwrite');
                        const store = transaction.objectStore('projects');
                        const request = store.delete(id);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }
            };

            // --- EXPORT HELPERS ---
            function showExportLoader(message) {
                let loader = document.getElementById('export-loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'export-loader';
                    loader.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; font-size: 1.5em;';
                    document.body.appendChild(loader);
                }
                loader.innerHTML = `<div class="flex flex-col items-center text-center p-4"><i data-lucide="loader-2" class="animate-spin w-12 h-12 mb-4"></i><p>${message}</p></div>`;
                lucide.createIcons();
                loader.style.display = 'flex';
            }

            function hideExportLoader() {
                const loader = document.getElementById('export-loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }

            // --- API LOGIC ---
            const flashApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${process.env.API_KEY}`;
            const imagenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${process.env.API_KEY}`;
            
            async function callApi(apiUrl, payload, isImagen) {
                const maxRetries = 3;
                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                        const result = await response.json();
                        const base64Data = isImagen ? result.predictions?.[0]?.bytesBase64Encoded : result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) return `data:image/png;base64,${base64Data}`;
                        console.error("Invalid API Response:", result);
                        throw new Error("API response did not contain a valid image.");
                    } catch (error) {
                        console.error(`Attempt ${attempt + 1} failed:`, error);
                        if (attempt >= maxRetries - 1) return null;
                        await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            
            async function upscaleImage(imageUrl, scale) {
                const instruction = `Eres un experto en restauración y mejora de imágenes. Tu tarea es mejorar la resolución de la siguiente imagen a ${scale}x su tamaño original. Aumenta la nitidez, la claridad y añade detalles finos y realistas apropiados para el estilo de la imagen, sin alterar la composición ni los elementos principales. Devuelve solo la imagen mejorada de alta resolución.`;
                const parts = [
                    { text: instruction },
                    { inlineData: { mimeType: `image/${imageUrl.split(';')[0].split('/')[1]}`, data: imageUrl.split(',')[1] } }
                ];
                const payload = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                return await callApi(flashApiUrl, payload, false);
            }

            /**
             * Edits an image using the Gemini API, incorporating character visual references for consistency.
             * @param {string} originalImageUrl - The base64 data URL of the image to edit.
             * @param {string} prompt - The user's text instruction for the edit.
             * @param {number[]} characterIds - An array of character IDs present in the panel, used to fetch reference images.
             * @returns {Promise<string|null>} A promise that resolves to the base64 data URL of the edited image, or null on failure.
             */
            async function editImage(originalImageUrl, prompt, characterIds = []) {
                const parts = [];
                let instruction = "Eres un editor de arte para cómics. Tu tarea es modificar la imagen de la viñeta principal (la primera imagen que te doy) basándote en una instrucción de texto. ";

                // Add the main panel image to be edited first
                parts.push({ inlineData: { mimeType: `image/${originalImageUrl.split(';')[0].split('/')[1]}`, data: originalImageUrl.split(',')[1] } });
                
                // Find and add character reference images
                const charactersInPanel = characterIds.map(id => project.characters.find(c => c.id === id)).filter(Boolean);
                if (charactersInPanel.length > 0) {
                    let hasRefs = false;
                    charactersInPanel.forEach(char => {
                        if (char.referenceImages && char.referenceImages.length > 0) {
                            hasRefs = true;
                            instruction += `Para el personaje '${char.name}', consulta las siguientes imágenes de referencia para mantener su apariencia. `;
                            char.referenceImages.forEach(img => {
                                parts.push({ inlineData: { mimeType: `image/${img.split(';')[0].split('/')[1]}`, data: img.split(',')[1] } });
                            });
                        }
                    });
                    if(hasRefs) {
                       instruction = "Eres un editor de arte para cómics. Tu tarea es modificar la imagen de la viñeta principal (la primera imagen que te doy) basándote en una instrucción de texto y manteniendo la consistencia de los personajes. ";
                    }
                }
                
                // Add the final user prompt
                instruction += `La instrucción de edición es: '${prompt}'. Devuelve solo la imagen editada, sin texto adicional.`;
                parts.unshift({ text: instruction });

                const payload = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                return await callApi(flashApiUrl, payload, false); 
            }

            async function generateImage(panel) {
                const panelCharacters = (panel.characterIds || []).map(id => project.characters.find(c => c.id === id));
                const panelClothing = (panel.clothingIds || []).map(id => project.clothing.find(c => c.id === id));
                const panelPoses = (panel.poseIds || []).map(p => project.poses.find(p => p.id === id));
                const background = project.backgrounds.find(b => b.id === panel.backgroundId);
                let parts = [];
                let instruction = "Crea una viñeta de cómic. Sigue las instrucciones y usa las imágenes de referencia. ";
                const panels = project.pages[activePageIndex].panels;
                const panelIndex = panels.findIndex(p => p.id === panel.id);
                if (panel.usePreviousAsRef && panelIndex > 0) {
                    let prevPanelWithImage = null;
                    for (let i = panelIndex - 1; i >= 0; i--) { if (panels[i].imageUrl) { prevPanelWithImage = panels[i]; break; } }
                    if (prevPanelWithImage) {
                        instruction += `La imagen ${parts.length + 1} es la viñeta anterior, úsala como referencia principal para la continuidad. `;
                        parts.push({ inlineData: { mimeType: `image/${prevPanelWithImage.imageUrl.split(';')[0].split('/')[1]}`, data: prevPanelWithImage.imageUrl.split(',')[1] } });
                    }
                }
                if (background?.referenceImage) {
                    instruction += `La imagen ${parts.length + 1} es el fondo de la escena. `;
                    parts.push({ inlineData: { mimeType: `image/${background.referenceImage.split(';')[0].split('/')[1]}`, data: background.referenceImage.split(',')[1] } });
                }
                panelCharacters.forEach(char => {
                    if (char.referenceImages && char.referenceImages.length > 0) {
                        const indices = [];
                        char.referenceImages.forEach(img => { indices.push(parts.length + 1); parts.push({ inlineData: { mimeType: `image/${img.split(';')[0].split('/')[1]}`, data: img.split(',')[1] } }); });
                        instruction += `Las imágenes ${indices.join(', ')} son para el personaje '${char.name}'. `;
                    }
                });
                [...panelClothing, ...panelPoses].forEach(item => {
                    if (item.referenceImage) {
                        instruction += `La imagen ${parts.length + 1} es para el objeto/ropa/pose '${item.name}'. `;
                        parts.push({ inlineData: { mimeType: `image/${item.referenceImage.split(';')[0].split('/')[1]}`, data: item.referenceImage.split(',')[1] } });
                    }
                });
                
                const characterPrompts = panelCharacters.map(c => `'${c.name}': (${c.prompt})`).join(', ');
                const clothingPrompts = panelClothing.map(c => `'${c.name}': (${c.prompt})`).join(', ');
                const posePrompts = panelPoses.map(p => `'${p.name}': (${p.prompt})`).join(', ');
                const backgroundPromptText = background ? `Fondo: ${background.prompt}.` : '';
                const fullPrompt = `Estilo de cómic. ${backgroundPromptText} Ropa/Accesorios: ${clothingPrompts || 'ninguno'}. Poses/Objetos: ${posePrompts || 'ninguno'}. Personajes: ${characterPrompts || 'ninguno'}. Descripción de la escena: ${panel.prompt}.`;
                parts.unshift({ text: instruction }); parts.push({ text: fullPrompt });
                const useFlash = parts.length > 2;
                if (useFlash) {
                    const payload = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                    return await callApi(flashApiUrl, payload, false);
                } else {
                    const payload = { instances: [{ prompt: fullPrompt }], parameters: { "sampleCount": 1 } };
                    return await callApi(imagenApiUrl, payload, true);
                }
            }
             async function removeImageBackground(imageUrl) {
                try {
                    const blob = await window.imgly.removeBackground(imageUrl);
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error("Error removing background:", error);
                    alert(`No se pudo eliminar el fondo. La imagen puede no ser compatible o la API falló. Detalles: ${error.message}`);
                    return null;
                }
            }

            // --- RENDER FUNCTIONS ---
            const getContrastingTextColor = (hex) => (!hex || ((parseInt(hex.replace("#", "").substr(0, 2), 16)*299 + parseInt(hex.substr(2, 2), 16)*587 + parseInt(hex.substr(4, 2), 16)*114)/1000) >= 128) ? '#000000' : '#FFFFFF';
            const renderList = (containerEl, items, msgEl, renderItem) => { containerEl.innerHTML = ''; if (items.length === 0) { if (msgEl) { msgEl.style.display = 'block'; containerEl.appendChild(msgEl); } } else { if (msgEl) msgEl.style.display = 'none'; items.forEach((item, index) => containerEl.appendChild(renderItem(item, index, items))); } lucide.createIcons(); };
            const createCharacterTag = (char) => { const el = document.createElement('div'); el.className = 'tag character-tag cursor-pointer p-2 rounded-lg flex items-center justify-between space-x-2'; el.style.backgroundColor = char.color; el.style.color = getContrastingTextColor(char.color); el.dataset.characterId = char.id; el.innerHTML = `<span class="font-bold text-sm pointer-events-none">${char.name}</span><div class="flex items-center"><button data-id="${char.id}" class="show-character-card-btn opacity-60 hover:opacity-100 mr-1 p-1" title="Ver Ficha de Personaje"><i data-lucide="user-square" class="w-3 h-3 pointer-events-none"></i></button><button data-id="${char.id}" class="edit-character-btn opacity-60 hover:opacity-100 mr-1 p-1"><i data-lucide="edit-2" class="w-3 h-3 pointer-events-none"></i></button><button data-id="${char.id}" class="delete-character-btn opacity-60 hover:opacity-100 p-1"><i data-lucide="x-circle" class="w-3 h-3 pointer-events-none"></i></button></div>`; return el; };
            const createVisualAssetTag = (item, type) => {
                const el = document.createElement('div');
                el.className = 'asset-tag tag cursor-pointer aspect-square rounded-lg flex items-end justify-between relative overflow-hidden shadow-lg';
                if (item.referenceImage) el.style.backgroundImage = `url(${item.referenceImage})`; else el.style.backgroundColor = '#4b5563';
                el.dataset[`${type}Id`] = item.id;
                el.innerHTML = `<div class="overlay absolute inset-0"></div><div class="relative z-10 p-1 w-full flex justify-between items-center"><span class="text-white font-bold text-xs">${item.name}</span><div class="flex items-center"><button data-id="${item.id}" class="edit-${type}-btn opacity-80 hover:opacity-100 p-1 bg-black/30 rounded-full"><i data-lucide="edit-2" class="w-3 h-3 text-white pointer-events-none"></i></button><button data-id="${item.id}" class="delete-${type}-btn opacity-80 hover:opacity-100 p-1 ml-1 bg-black/30 rounded-full"><i data-lucide="x-circle" class="w-3 h-3 text-white pointer-events-none"></i></button></div></div>`;
                return el;
            };
            const createBackgroundTag = (bg) => { const el = document.createElement('div'); el.className = 'asset-tag tag cursor-pointer aspect-video rounded-lg flex items-end justify-between relative overflow-hidden shadow-lg'; if (bg.referenceImage) el.style.backgroundImage = `url(${bg.referenceImage})`; else el.style.backgroundColor = '#4b5563'; el.dataset.backgroundId = bg.id; el.innerHTML = `<div class="overlay absolute inset-0"></div><div class="relative z-10 p-2 w-full flex justify-between items-center"><span class="text-white font-bold text-sm">${bg.name}</span><div class="flex items-center"><button data-id="${bg.id}" class="edit-background-btn opacity-80 hover:opacity-100 p-1 bg-black/30 rounded-full"><i data-lucide="edit-2" class="w-3 h-3 text-white pointer-events-none"></i></button><button data-id="${bg.id}" class="delete-background-btn opacity-80 hover:opacity-100 p-1 ml-1 bg-black/30 rounded-full"><i data-lucide="x-circle" class="w-3 h-3 text-white pointer-events-none"></i></button></div></div>`; return el; };
            function showCharacterCard(characterId) {
                const character = project.characters.find(c => c.id === characterId);
                if (!character) return;

                const cardModal = getEl('character-card-modal');
                let imagesHTML = '<p class="text-gray-400 text-sm col-span-full text-center">Sin imágenes de referencia.</p>';
                if (character.referenceImages && character.referenceImages.length > 0) {
                    imagesHTML = character.referenceImages.map(imgSrc => `
                        <div class="aspect-square bg-gray-900 rounded-md overflow-hidden">
                            <img src="${imgSrc}" class="w-full h-full object-cover">
                        </div>
                    `).join('');
                }

                const canGenerateSheet = character.referenceImages && character.referenceImages.length > 0;

                const cardHTML = `
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col animate-fade-in">
                        <div class="p-4 rounded-t-xl" style="background-color: ${character.color};">
                            <h2 class="text-2xl font-bold" style="color: ${getContrastingTextColor(character.color)};">${character.name}</h2>
                        </div>
                        <div class="p-6 flex-grow overflow-y-auto space-y-6">
                            <div>
                                <h3 class="font-semibold text-lg text-gray-200 mb-2">Descripción (Prompt)</h3>
                                <p class="bg-gray-900/50 p-3 rounded-md text-gray-300 text-sm whitespace-pre-wrap">${character.prompt}</p>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg text-gray-200 mb-2">Galería de Referencia</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                    ${imagesHTML}
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg text-gray-200 mb-2">Hoja de Diseño de Personaje</h3>
                                <p class="text-sm text-gray-400 mb-3">Usa la IA para generar una hoja de diseño con poses, expresiones y colores a partir de las imágenes de referencia.</p>
                                <button id="generate-character-sheet-btn" data-character-id="${character.id}" class="w-full flex items-center justify-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" ${!canGenerateSheet ? 'disabled' : ''}>
                                    <i data-lucide="wand-2" class="w-5 h-5"></i>
                                    <span>Generar Hoja de Personaje</span>
                                </button>
                                ${!canGenerateSheet ? '<p class="text-xs text-amber-400 mt-2 text-center">Añade al menos una imagen de referencia para poder generar la hoja de diseño.</p>' : ''}
                                <div id="character-sheet-result" class="mt-4 w-full aspect-square bg-gray-900/50 rounded-md flex items-center justify-center text-gray-500 relative">
                                    <i data-lucide="image" class="w-16 h-16"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 text-right">
                            <button id="close-character-card-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
                        </div>
                    </div>
                `;

                cardModal.innerHTML = cardHTML;
                cardModal.classList.remove('hidden');
                lucide.createIcons();
            }
            async function generateCharacterSheet(character) {
                const resultContainer = document.getElementById('character-sheet-result');
                const genButton = document.getElementById('generate-character-sheet-btn');
                if (genButton) genButton.disabled = true;
                
                resultContainer.innerHTML = `<div class="flex flex-col items-center justify-center text-center"><i data-lucide="loader-2" class="animate-spin w-12 h-12 text-white"></i><p class="mt-2 text-sm text-gray-400">Generando hoja de personaje... Esto puede tardar un momento.</p></div>`;
                lucide.createIcons();

                let parts = [];
                const instruction = `Crea una hoja de diseño de personaje (character sheet) profesional para un cómic. El personaje se llama '${character.name}'. Su descripción es: '${character.prompt}'. Utiliza las imágenes de referencia proporcionadas para mantener la consistencia en el diseño. La hoja debe incluir: una pose de cuerpo completo, 3-4 expresiones faciales diferentes (ej. feliz, enfadado, triste), y la paleta de colores principal del personaje. Mantén un estilo de cómic limpio y claro, con un fondo blanco o neutro.`;
                parts.push({ text: instruction });

                character.referenceImages.forEach(img => {
                    parts.push({ inlineData: { mimeType: `image/${img.split(';')[0].split('/')[1]}`, data: img.split(',')[1] } });
                });

                const payload = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } };
                const imageUrl = await callApi(flashApiUrl, payload, false);

                if (imageUrl) {
                    resultContainer.innerHTML = `
                        <img src="${imageUrl}" class="w-full h-full object-contain rounded-md">
                        <div class="absolute bottom-2 right-2 flex space-x-2">
                            <a href="${imageUrl}" download="${character.name.replace(/\s+/g, '_')}_sheet.png" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg" title="Descargar"><i data-lucide="download" class="w-5 h-5"></i></a>
                            <button data-character-id="${character.id}" data-image-url="${imageUrl}" class="add-sheet-to-gallery-btn bg-green-600 hover:bg-green-700 text-white p-2 rounded-full shadow-lg" title="Añadir a Galería"><i data-lucide="plus-circle" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                    `;
                } else {
                    resultContainer.innerHTML = '<p class="text-red-400 text-center">No se pudo generar la hoja de personaje. Inténtalo de nuevo.</p>';
                    if (genButton) genButton.disabled = false;
                }
                lucide.createIcons();
            }
            function renderPages() {
                pagesList.innerHTML = '';
                if (project.pages.length === 0) {
                    pagesList.innerHTML = '<p class="text-gray-500 text-sm w-full text-center">Añade tu primera página.</p>';
                } else {
                    project.pages.forEach((page, index) => {
                        const el = document.createElement('div');
                        el.draggable = true;
                        const isActive = index === activePageIndex;
                        const firstImage = page.panels.find(p => p.imageUrl)?.imageUrl;
                        el.className = `page-thumb cursor-pointer flex-shrink-0 w-24 h-16 rounded-lg flex items-center justify-center text-center relative border-2 ${isActive ? 'border-indigo-500' : 'border-gray-700'}`;
                        if (firstImage) el.style.backgroundImage = `url(${firstImage})`;
                        else el.style.backgroundColor = '#374151';
                        el.dataset.pageIndex = index;
                        el.innerHTML = `<div class="overlay absolute inset-0 rounded-md"></div><span class="relative z-10 font-bold text-white text-lg">${index + 1}</span><button data-page-index="${index}" class="delete-page-btn absolute top-[-10px] right-[-10px] bg-red-600/80 hover:bg-red-600 text-white rounded-full p-0.5 z-20"><i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i></button>`;
                        pagesList.appendChild(el);
                    });
                }
                lucide.createIcons();
            }
            function renderPanels() {
                const panels = project.pages[activePageIndex]?.panels || [];
                renderList(panelsList, panels, noPanelsMsg, (panel, index, panels) => {
                    const el = document.createElement('div'); el.draggable = true;
                    el.className = `panel-card p-3 bg-gray-800 rounded-lg border border-gray-700 transition-colors ${panel.isLoading ? 'panel-generating' : ''} ${panel.id === selectedPanelId ? 'selected-panel' : ''}`;
                    el.dataset.panelId = panel.id;
                    const panelChars = panel.characterIds.map(id => project.characters.find(c => c.id === id));
                    const panelBg = project.backgrounds.find(b => b.id === panel.backgroundId);
                    const panelClothing = panel.clothingIds.map(id => project.clothing.find(c => c.id === id));
                    const panelPoses = panel.poseIds.map(id => project.poses.find(p => p.id === id));
                    
                    const shapeOptions = [
                        { type: 'rectangle', icon: 'square', title: 'Rectángulo' }, { type: 'diagonal', icon: 'slash', title: 'Corte Diagonal' },
                        { type: 'trapezoid', icon: 'chevrons-up', title: 'Trapecio' }, { type: 'banner', icon: 'panel-top', title: 'Anuncio' },
                        { type: 'circle', icon: 'circle', title: 'Círculo' }, { type: 'burst', icon: 'zap', title: 'Ráfaga' },
                        { type: 'hexagon', icon: 'hexagon', title: 'Hexágono' }, { type: 'diamond', icon: 'diamond', title: 'Rombo' }
                    ];
                    const shapeButtons = shapeOptions.map(opt => `<button type="button" class="shape-btn p-1 rounded ${panel.shape === opt.type ? 'bg-indigo-500 text-white' : 'bg-gray-600 text-gray-300 hover:bg-gray-500'}" data-shape="${opt.type}" title="${opt.title}"><i data-lucide="${opt.icon}" class="w-4 h-4 pointer-events-none"></i></button>`).join('');

                    el.innerHTML = `<div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-bold text-gray-400 pointer-events-none">Viñeta #${index + 1}</span>
                        <div class="flex items-center space-x-1">
                          <button data-id="${panel.id}" class="move-panel-up-btn text-gray-500 hover:text-green-400 p-1 ${index === 0 ? 'opacity-25 cursor-not-allowed' : ''}" title="Mover Arriba" ${index === 0 ? 'disabled' : ''}><i data-lucide="arrow-up-circle" class="w-4 h-4"></i></button>
                          <button data-id="${panel.id}" class="move-panel-down-btn text-gray-500 hover:text-green-400 p-1 ${index === panels.length - 1 ? 'opacity-25 cursor-not-allowed' : ''}" title="Mover Abajo" ${index === panels.length - 1 ? 'disabled' : ''}><i data-lucide="arrow-down-circle" class="w-4 h-4"></i></button>
                          <button data-id="${panel.id}" class="move-panel-next-page-btn text-gray-500 hover:text-teal-400 p-1" title="Mover a Siguiente Página"><i data-lucide="arrow-right-circle" class="w-4 h-4"></i></button>
                          <button data-id="${panel.id}" class="convert-to-overlay-btn text-gray-500 hover:text-amber-400 p-1" title="Convertir en Capa"><i data-lucide="layers" class="w-4 h-4"></i></button>
                          <button data-id="${panel.id}" class="duplicate-panel-btn text-gray-500 hover:text-blue-400 p-1" title="Duplicar Viñeta"><i data-lucide="copy" class="w-4 h-4"></i></button>
                          <button data-id="${panel.id}" class="delete-panel-btn text-gray-500 hover:text-red-500 p-1" title="Eliminar Viñeta"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <textarea class="panel-prompt w-full bg-gray-700 rounded-md px-2 py-1 text-white text-sm" rows="2" placeholder="Describe la acción...">${panel.prompt}</textarea>
                    <div class="mt-2 text-xs text-gray-400 pointer-events-none">Fondo: <span class="font-semibold text-purple-300">${panelBg ? panelBg.name : 'Ninguno'}</span></div>
                    <div class="mt-1 text-xs text-gray-400 pointer-events-none">Personajes: <span class="font-semibold text-blue-300">${panelChars.length > 0 ? panelChars.map(c => c.name).join(', ') : 'Ninguno'}</span></div>
                    <div class="mt-1 text-xs text-gray-400 pointer-events-none">Ropa/Accesorios: <span class="font-semibold text-pink-300">${panelClothing.length > 0 ? panelClothing.map(c => c.name).join(', ') : 'Ninguno'}</span></div>
                    <div class="mt-1 text-xs text-gray-400 pointer-events-none">Poses/Objetos: <span class="font-semibold text-cyan-300">${panelPoses.length > 0 ? panelPoses.map(p => p.name).join(', ') : 'Ninguno'}</span></div>
                    <div class="mt-2 flex items-center justify-between">
                        <div class="flex items-center space-x-1 flex-wrap gap-1">
                            <span class="text-xs text-gray-400 mr-1 pointer-events-none">Forma:</span>
                            ${shapeButtons}
                        </div>
                    </div>
                    <div class="mt-2 flex items-center justify-between">
                         <div class="flex items-center space-x-1">
                            <span class="text-xs text-gray-400 mr-1 pointer-events-none">Tamaño:</span>
                            <button type="button" class="panel-size-btn p-1 rounded bg-gray-600 text-gray-300 hover:bg-gray-500" data-change="-1" title="Más Pequeño"><i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i></button>
                            <span class="text-sm font-semibold text-white w-4 text-center pointer-events-none">${panel.size || 1}</span>
                            <button type="button" class="panel-size-btn p-1 rounded bg-gray-600 text-gray-300 hover:bg-gray-500" data-change="1" title="Más Grande"><i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                        <div class="flex items-center space-x-2"><input type="checkbox" id="ref-prev-${panel.id}" data-id="${panel.id}" class="ref-prev-checkbox bg-gray-700 rounded" ${panel.usePreviousAsRef ? 'checked' : ''}><label for="ref-prev-${panel.id}" class="text-xs text-gray-400 cursor-pointer">Ref. Anterior</label></div>
                    </div>
                    <div class="mt-3 grid grid-cols-2 gap-2">
                        <button data-id="${panel.id}" class="generate-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-2 rounded-lg text-sm flex items-center justify-center" ${panel.isLoading ? 'disabled' : ''}>
                            ${panel.isLoading ? '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>' : '<i data-lucide="wand-2" class="w-4 h-4 mr-1"></i><span>Generar</span>'}
                        </button>
                        <button data-id="${panel.id}" class="upload-panel-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded-lg text-sm flex items-center justify-center" title="Subir Imagen">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                        </button>
                    </div>`;
                    
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('textarea, input, button, label')) return;
                        selectedPanelId = panel.id;
                        render();
                    });

                    el.querySelectorAll('textarea, input, button').forEach(interactiveEl => {
                        interactiveEl.addEventListener('click', async e => {
                            e.stopPropagation();
                            const currentTarget = e.currentTarget;
                            if (currentTarget.closest('.delete-panel-btn')) {
                                project.pages[activePageIndex].panels = project.pages[activePageIndex].panels.filter(p => p.id !== panel.id);
                                if (selectedPanelId === panel.id) selectedPanelId = null;
                                updateAndSave();
                            } else if (currentTarget.closest('.move-panel-up-btn')) {
                                const panels = project.pages[activePageIndex].panels;
                                const index = panels.findIndex(p => p.id === panel.id);
                                if (index > 0) {
                                    [panels[index], panels[index - 1]] = [panels[index - 1], panels[index]];
                                    updateAndSave();
                                }
                            } else if (currentTarget.closest('.move-panel-down-btn')) {
                                const panels = project.pages[activePageIndex].panels;
                                const index = panels.findIndex(p => p.id === panel.id);
                                if (index < panels.length - 1) {
                                    [panels[index], panels[index + 1]] = [panels[index + 1], panels[index]];
                                    updateAndSave();
                                }
                            } else if (currentTarget.closest('.move-panel-next-page-btn')) {
                                const panelIndex = project.pages[activePageIndex].panels.findIndex(p => p.id === panel.id);
                                if (panelIndex > -1) {
                                    const panelToMove = project.pages[activePageIndex].panels.splice(panelIndex, 1)[0];
                                    if (activePageIndex + 1 < project.pages.length) {
                                        project.pages[activePageIndex + 1].panels.push(panelToMove);
                                    } else {
                                        const newPage = { id: nextId.page++, panels: [panelToMove], overlayPanels: [], texts: [], layout: 'default', backgroundColor: '#ffffff' };
                                        project.pages.push(newPage);
                                    }
                                    updateAndSave();
                                }
                            } else if (currentTarget.closest('.duplicate-panel-btn')) {
                                const newPanel = JSON.parse(JSON.stringify(panel)); newPanel.id = nextId.panel++;
                                const currentIndex = project.pages[activePageIndex].panels.findIndex(p => p.id === panel.id);
                                project.pages[activePageIndex].panels.splice(currentIndex + 1, 0, newPanel);
                                updateAndSave();
                            } else if (currentTarget.closest('.generate-btn')) {
                                panel.isLoading = true; renderPanels();
                                const imageUrl = await generateImage(panel);
                                if (imageUrl) panel.imageUrl = imageUrl;
                                panel.isLoading = false; updateAndSave();
                            } else if (currentTarget.closest('.upload-panel-btn')) {
                                currentlyUploadingToPanelId = panel.id;
                                getEl('panel-image-upload').click();
                            } else if (currentTarget.closest('.shape-btn')) {
                                panel.shape = currentTarget.dataset.shape; updateAndSave();
                            } else if (currentTarget.closest('.panel-size-btn')) {
                                const change = parseInt(currentTarget.dataset.change); panel.size = Math.max(1, Math.min(6, (panel.size || 1) + change)); updateAndSave();
                            } else if (currentTarget.closest('.convert-to-overlay-btn')) {
                                const panelToConvert = project.pages[activePageIndex].panels.find(p => p.id === panel.id);
                                if(panelToConvert) {
                                    const newOverlay = {
                                        id: 'o' + nextId.overlayPanel++, prompt: panelToConvert.prompt, imageUrl: panelToConvert.imageUrl,
                                        shape: panelToConvert.shape, x: 10, y: 10, width: 200, height: 150, opacity: 1,
                                        zIndex: (project.pages[activePageIndex].overlayPanels.length + 1) * 20, isLoading: false
                                    };
                                    project.pages[activePageIndex].overlayPanels.push(newOverlay);
                                    project.pages[activePageIndex].panels = project.pages[activePageIndex].panels.filter(p => p.id !== panel.id);
                                    selectedPanelId = null; selectedOverlayPanelId = newOverlay.id;
                                    updateAndSave();
                                }
                            }
                        });
                    });
                    return el;
                });
            }
             function renderOverlayPanels() {
                const overlayPanels = project.pages[activePageIndex]?.overlayPanels || [];
                renderList(overlayPanelsList, overlayPanels, noOverlayPanelsMsg, (panel, index) => {
                    const el = document.createElement('div');
                    el.className = `panel-card p-3 bg-gray-800 rounded-lg border border-gray-700 ${panel.isLoading ? 'panel-generating' : ''} ${panel.id === selectedOverlayPanelId ? 'selected-panel' : ''}`;
                    el.dataset.overlayPanelId = panel.id;
                    
                    const shapeOptions = [ { type: 'rectangle', icon: 'square', title: 'Rectángulo' }, { type: 'circle', icon: 'circle', title: 'Círculo' } ];
                    const shapeButtons = shapeOptions.map(opt => `<button type="button" class="overlay-shape-btn p-1 rounded ${panel.shape === opt.type ? 'bg-indigo-500 text-white' : 'bg-gray-600 text-gray-300 hover:bg-gray-500'}" data-shape="${opt.type}" title="${opt.title}"><i data-lucide="${opt.icon}" class="w-4 h-4 pointer-events-none"></i></button>`).join('');

                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-bold text-gray-400 pointer-events-none">Capa #${index + 1}</span>
                            <div class="flex items-center space-x-2">
                              <button data-id="${panel.id}" class="convert-to-panel-btn text-gray-500 hover:text-green-400" title="Convertir en Viñeta"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                              <button data-id="${panel.id}" class="delete-overlay-panel-btn text-gray-500 hover:text-red-500" title="Eliminar Capa"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <textarea class="overlay-panel-prompt w-full bg-gray-700 rounded-md px-2 py-1 text-white text-sm" rows="2" placeholder="Describe la acción...">${panel.prompt || ''}</textarea>
                        <div class="mt-2 flex items-center justify-between">
                            <div class="flex items-center space-x-1">
                                <span class="text-xs text-gray-400 mr-1 pointer-events-none">Forma:</span>
                                ${shapeButtons}
                            </div>
                        </div>
                         <div class="mt-2 flex items-center space-x-2">
                            <label for="opacity-${panel.id}" class="text-xs text-gray-400 pointer-events-none">Opacidad:</label>
                            <input type="range" id="opacity-${panel.id}" min="0" max="1" step="0.05" value="${panel.opacity ?? 1}" class="overlay-opacity-slider w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-2">
                            <button data-id="${panel.id}" class="generate-overlay-btn w-full bg-amber-600 hover:bg-amber-700 text-white font-bold p-2 rounded-lg text-sm flex items-center justify-center" ${panel.isLoading ? 'disabled' : ''} title="Generar con IA">
                                ${panel.isLoading ? '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>' : '<i data-lucide="wand-2" class="w-4 h-4"></i>'}
                            </button>
                            <button data-id="${panel.id}" class="remove-bg-btn w-full bg-pink-600 hover:bg-pink-700 text-white font-bold p-2 rounded-lg text-sm flex items-center justify-center" ${!panel.imageUrl || panel.isLoading ? 'disabled' : ''} title="Eliminar Fondo">
                                <i data-lucide="eraser" class="w-4 h-4"></i>
                            </button>
                            <button data-id="${panel.id}" class="upload-layer-image-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg text-sm flex items-center justify-center" ${panel.isLoading ? 'disabled' : ''} title="Subir Imagen">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;

                    el.addEventListener('click', (e) => {
                         if (e.target.closest('textarea, input, button')) return;
                         selectedOverlayPanelId = panel.id;
                         render();
                    });

                    el.querySelectorAll('textarea, button').forEach(interactiveEl => {
                        interactiveEl.addEventListener('click', async e => {
                            e.stopPropagation(); const currentTarget = e.currentTarget;
                            if (currentTarget.closest('.delete-overlay-panel-btn')) {
                                project.pages[activePageIndex].overlayPanels = project.pages[activePageIndex].overlayPanels.filter(p => p.id !== panel.id);
                                if (selectedOverlayPanelId === panel.id) selectedOverlayPanelId = null;
                                updateAndSave();
                            } else if (currentTarget.closest('.generate-overlay-btn')) {
                                panel.isLoading = true; renderOverlayPanels();
                                const imageUrl = await generateImage(panel);
                                if (imageUrl) panel.imageUrl = imageUrl;
                                panel.isLoading = false; updateAndSave();
                            } else if (currentTarget.closest('.remove-bg-btn')) {
                                if(!panel.imageUrl) return;
                                panel.isLoading = true; renderOverlayPanels();
                                const newImageUrl = await removeImageBackground(panel.imageUrl);
                                if(newImageUrl) panel.imageUrl = newImageUrl;
                                panel.isLoading = false; updateAndSave();
                            } else if (currentTarget.closest('.upload-layer-image-btn')) {
                                currentlyUploadingToLayerId = panel.id;
                                getEl('layer-image-upload').click();
                            } else if (currentTarget.closest('.overlay-shape-btn')) {
                                panel.shape = currentTarget.dataset.shape; updateAndSave();
                            } else if (currentTarget.closest('.convert-to-panel-btn')) {
                                const overlayToConvert = project.pages[activePageIndex].overlayPanels.find(p => p.id === panel.id);
                                if(overlayToConvert) {
                                    const newPanel = {
                                        id: nextId.panel++, prompt: overlayToConvert.prompt || '', imageUrl: overlayToConvert.imageUrl,
                                        shape: overlayToConvert.shape || 'rectangle', size: 1, usePreviousAsRef: false,
                                        characterIds: [], backgroundId: null, clothingIds: [], poseIds: [],
                                        transform: { zoom: 1, panX: 50, panY: 50 }, isLoading: false
                                    };
                                    project.pages[activePageIndex].panels.push(newPanel);
                                    project.pages[activePageIndex].overlayPanels = project.pages[activePageIndex].overlayPanels.filter(p => p.id !== panel.id);
                                    selectedOverlayPanelId = null; selectedPanelId = newPanel.id;
                                    updateAndSave();
                                }
                            }
                        });
                    });
                     const slider = el.querySelector('.overlay-opacity-slider');
                     if(slider) { slider.addEventListener('input', e => { e.stopPropagation(); panel.opacity = parseFloat(e.target.value); renderPreview(); debouncedAutosave(); }); }
                    return el;
                });
            }
            function renderPreview() {
                const currentPage = project.pages[activePageIndex];
                if (!currentPage) return;
                const pageLayout = currentPage.layout || 'default';
                const bgColor = currentPage.backgroundColor || '#ffffff';
                
                comicPreviewContainer.style.backgroundColor = bgColor;
                pageBgColorPicker.value = bgColor;

                comicPreview.className = 'gap-4'; // Reset classes
                comicPreview.classList.add('layout', `layout-${pageLayout}`);

                layoutPopover.querySelectorAll('.layout-option-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.layout === pageLayout));
                
                const panels = currentPage.panels || [];
                const overlayPanels = currentPage.overlayPanels || [];
                const imagePanels = panels.filter(p => p.imageUrl); 
                comicPreview.innerHTML = '';
                
                if (imagePanels.length === 0 && overlayPanels.length === 0) { 
                    comicPreview.appendChild(previewPlaceholder); 
                } else {
                    imagePanels.forEach(panel => {
                        const panelDiv = document.createElement('div');
                        panelDiv.dataset.panelId = panel.id;
                        panelDiv.className = `comic-panel rounded-lg overflow-hidden flex items-center justify-center transition-all duration-300 panel-shape-${panel.shape} ${panel.id === selectedPanelId ? 'selected-panel' : ''}`;
                        panelDiv.style.backgroundColor = 'transparent';
                        panelDiv.style.gridColumn = `span ${panel.size || 1}`;
                        if (pageLayout !== 'webtoon') panelDiv.classList.add('aspect-video');
                        const transform = panel.transform || { zoom: 1, panX: 50, panY: 50 };
                        panelDiv.innerHTML = `<img src="${panel.imageUrl}" class="w-full h-full object-cover transition-transform duration-200" style="transform-origin: ${transform.panX}% ${transform.panY}%; transform: scale(${transform.zoom});">
                        <div class="panel-actions">
                            <button data-panel-id="${panel.id}" title="Mejorar Resolución" class="upscale-panel-btn bg-black/50 hover:bg-black/80 text-white p-2 rounded-full"><i data-lucide="maximize" class="w-5 h-5 pointer-events-none"></i></button>
                            <button data-panel-id="${panel.id}" title="Ajustar Encuadre" class="toggle-framing-btn bg-black/50 hover:bg-black/80 text-white p-2 rounded-full"><i data-lucide="frame" class="w-5 h-5 pointer-events-none"></i></button>
                            <button data-panel-id="${panel.id}" title="Editar Viñeta" class="edit-panel-btn bg-black/50 hover:bg-black/80 text-white p-2 rounded-full"><i data-lucide="edit" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                        <div class="upscale-options hidden absolute bottom-14 right-8 bg-gray-900/80 backdrop-blur-sm rounded-lg shadow-lg p-1 flex flex-col gap-1 z-30 w-24">
                            <button class="upscale-choice-btn text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 w-full text-left" data-scale="2">Mejorar x2</button>
                            <button class="upscale-choice-btn text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 w-full text-left" data-scale="4">Mejorar x4</button>
                        </div>
                        <div class="framing-controls hidden" data-panel-id="${panel.id}">
                             <label><i data-lucide="zoom-in" class="w-3 h-3"></i><input type="range" class="zoom-slider" min="1" max="3" step="0.05" value="${transform.zoom}"></label>
                             <label><i data-lucide="move-horizontal" class="w-3 h-3"></i><input type="range" class="pan-x-slider" min="0" max="100" step="1" value="${transform.panX}"></label>
                             <label><i data-lucide="move-vertical" class="w-3 h-3"></i><input type="range" class="pan-y-slider" min="0" max="100" step="1" value="${transform.panY}"></label>
                        </div>`;
                        comicPreview.appendChild(panelDiv);
                    });
                }
                
                overlayPanelLayer.innerHTML = '';
                overlayPanels.forEach(panel => {
                    const el = document.createElement('div');
                    el.dataset.overlayPanelId = panel.id;
                    el.className = `overlay-panel group panel-shape-${panel.shape} ${panel.id === selectedOverlayPanelId ? 'selected' : ''}`;
                    if (panel.imageUrl) {
                        el.style.backgroundColor = 'transparent';
                    }
                    el.style.left = `${panel.x}%`; el.style.top = `${panel.y}%`;
                    el.style.width = `${panel.width}px`; el.style.height = `${panel.height}px`;
                    el.style.zIndex = panel.zIndex || 20;
                    el.style.opacity = panel.opacity ?? 1;
                    el.innerHTML = `
                        ${panel.imageUrl ? `<img src="${panel.imageUrl}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-white text-xs p-2 text-center">Genera o sube una imagen para esta capa</div>`}
                        <div class="panel-actions opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-panel-id="${panel.id}" title="Mejorar Resolución" class="upscale-overlay-btn bg-black/50 hover:bg-black/80 text-white p-2 rounded-full"><i data-lucide="maximize" class="w-5 h-5 pointer-events-none"></i></button>
                        </div>
                        <div class="upscale-options hidden absolute top-14 right-2 bg-gray-900/80 backdrop-blur-sm rounded-lg shadow-lg p-1 flex flex-col gap-1 z-30 w-24">
                            <button class="upscale-choice-btn text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 w-full text-left" data-scale="2" data-type="overlay">Mejorar x2</button>
                            <button class="upscale-choice-btn text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 w-full text-left" data-scale="4" data-type="overlay">Mejorar x4</button>
                        </div>
                        <div class="resizer"></div>
                    `;
                    overlayPanelLayer.appendChild(el);
                });

                textOverlay.innerHTML = '';
                const texts = currentPage.texts || [];
                texts.forEach(textItem => {
                    const el = document.createElement('div');
                    el.className = 'text-overlay-element pointer-events-auto'; el.dataset.textId = textItem.id;
                    el.style.left = `${textItem.x}%`; el.style.top = `${textItem.y}%`; el.style.fontSize = `${textItem.size}px`;
                    el.style.transform = `rotate(${textItem.rotation}deg)`; el.style.width = textItem.width ? `${textItem.width}px` : 'auto';
                    el.style.zIndex = textItem.zIndex || 10;
                    const content = document.createElement('div');
                    content.className = textItem.className; content.textContent = textItem.text;
                    if (textItem.font) content.style.fontFamily = textItem.font;
                    el.appendChild(content); textOverlay.appendChild(el);
                });
                lucide.createIcons();
            }
            function render() {
                renderPages();
                renderList(charactersList, project.characters, noCharactersMsg, createCharacterTag);
                renderList(backgroundsList, project.backgrounds, noBackgroundsMsg, createBackgroundTag);
                renderList(clothingList, project.clothing, noClothingMsg, item => createVisualAssetTag(item, 'clothing'));
                renderList(posesList, project.poses, noPosesMsg, item => createVisualAssetTag(item, 'pose'));
                renderPanels();
                renderOverlayPanels();
                renderPreview();
                currentPageNumber.textContent = activePageIndex + 1;
            }

            // --- AUTOSAVE & RESTORE ---
            let autosaveTimeout;
            async function autosaveProject() {
                if (autosaveTimeout) clearTimeout(autosaveTimeout);
                const dataToSave = { project, nextId };
                try {
                    await db.saveProject('autosave', dataToSave);
                    const statusEl = getEl('autosave-status');
                    if (statusEl) {
                        statusEl.textContent = 'Guardado.';
                        statusEl.classList.remove('opacity-0');
                        autosaveTimeout = setTimeout(() => { statusEl.classList.add('opacity-0'); }, 2000);
                    }
                } catch (error) {
                    console.error("Fallo al autoguardar en IndexedDB:", error);
                    const statusEl = getEl('autosave-status');
                    if (statusEl) {
                        statusEl.textContent = 'Error al guardar.';
                        statusEl.style.color = 'red';
                        statusEl.classList.remove('opacity-0');
                    }
                }
            }

            let debounceTimer;
            function debouncedAutosave() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    autosaveProject();
                }, 1000);
            }

            function updateAndSave() {
                render();
                autosaveProject();
            }

            async function checkForAutosave() {
                try {
                    const savedData = await db.getProject('autosave');
                    if (savedData) {
                        const promptEl = getEl('restore-prompt');
                        promptEl.classList.remove('hidden');

                        getEl('restore-btn').onclick = () => {
                            try {
                                const { project: loadedProject, nextId: loadedNextId } = savedData;
                                project = loadedProject;
                                nextId = loadedNextId;
                                project.pages.forEach(page => { if (!page.overlayPanels) page.overlayPanels = []; if (!page.backgroundColor) page.backgroundColor = '#ffffff'; if (!page.texts) page.texts = []; page.panels.forEach(panel => { if (!panel.size) panel.size = 1; if (!panel.shape) panel.shape = 'rectangle'; if(!panel.transform) panel.transform = { zoom: 1, panX: 50, panY: 50 }; }); });
                                activePageIndex = 0;
                                selectedPanelId = null;
                                selectedOverlayPanelId = null;
                                render();
                                alert('Proyecto restaurado desde el autoguardado.');
                            } catch (err) {
                                alert('Error al restaurar el proyecto autoguardado.');
                                console.error(err);
                                db.deleteProject('autosave');
                            } finally {
                                promptEl.classList.add('hidden');
                            }
                        };

                        getEl('discard-restore-btn').onclick = async () => {
                            await db.deleteProject('autosave');
                            promptEl.classList.add('hidden');
                        };
                    }
                } catch (error) {
                    console.error("No se pudo comprobar el autoguardado en IndexedDB:", error);
                }
            }
            
            // --- PROJECT SAVE/LOAD & SCRIPT IMPORT ---
            function saveProjectToFile() { const dataStr = JSON.stringify({ project, nextId }); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.download = 'mi-comic.comicproject'; link.href = url; link.click(); URL.revokeObjectURL(url); }
            function loadProject(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const { project: loadedProject, nextId: loadedNextId } = JSON.parse(e.target.result); project = loadedProject; nextId = loadedNextId; project.pages.forEach(page => { if (!page.overlayPanels) page.overlayPanels = []; if (!page.backgroundColor) page.backgroundColor = '#ffffff'; if (!page.texts) page.texts = []; page.panels.forEach(panel => { if (!panel.size) panel.size = 1; if (!panel.shape) panel.shape = 'rectangle'; if(!panel.transform) panel.transform = { zoom: 1, panX: 50, panY: 50 }; }); }); activePageIndex = 0; selectedPanelId = null; selectedOverlayPanelId = null; render(); alert('Proyecto cargado exitosamente.'); } catch (err) { alert('Error al cargar el archivo del proyecto.'); console.error(err); } }; reader.readAsText(file); }
            function importScript() {
                const text = getEl('script-editor').value;
                if (!text.trim()) return alert('El guion está vacío.');
                
                project.pages = [];
                let currentPage = null;
                let currentPanel = null;
                const lines = text.split('\n');

                lines.forEach(line => {
                    const pageMatch = line.match(/^\[PÁGINA\s*(\d+)?\]/i);
                    const panelMatch = line.match(/^\[VIÑETA\s*(\d+)?\]/i);
                    const bgMatch = line.match(/^FONDO:\s*(.*)/i);
                    const charMatch = line.match(/^PERSONAJE(?:S)?:\s*(.*)/i);
                    const poseMatch = line.match(/^POSE(?:S)?|OBJETO(?:S)?:\s*(.*)/i);
                    const clothingMatch = line.match(/^ROPA|ACCESORIO(?:S)?:\s*(.*)/i);
                    const promptMatch = line.match(/^PROMPT:\s*(.*)/i);
                    const dialogueMatch = line.match(/^DIALOGO\s*\((.*?)\):\s*(.*)/i);

                    if (pageMatch) {
                        currentPage = { id: nextId.page++, panels: [], overlayPanels: [], texts: [], layout: 'default', backgroundColor: '#ffffff' };
                        project.pages.push(currentPage);
                        currentPanel = null;
                    } else if (panelMatch) {
                        if (!currentPage) { currentPage = { id: nextId.page++, panels: [], overlayPanels: [], texts: [], layout: 'default', backgroundColor: '#ffffff' }; project.pages.push(currentPage); }
                        currentPanel = { id: nextId.panel++, prompt: '', characterIds: [], backgroundId: null, clothingIds: [], poseIds: [], imageUrl: null, isLoading: false, shape: 'rectangle', size: 1, usePreviousAsRef: false, transform: { zoom: 1, panX: 50, panY: 50 } };
                        currentPage.panels.push(currentPanel);
                    } else if (bgMatch && currentPanel) {
                        const bgName = bgMatch[1].trim();
                        let bg = project.backgrounds.find(b => b.name.toLowerCase() === bgName.toLowerCase());
                        if (!bg) { bg = { id: nextId.background++, name: bgName, prompt: `Un fondo de ${bgName}`, referenceImage: null }; project.backgrounds.push(bg); }
                        currentPanel.backgroundId = bg.id;
                    } else if (charMatch && currentPanel) {
                        const charNames = charMatch[1].split(',').map(s => s.trim());
                        charNames.forEach(name => {
                            const charName = name.split('(')[0].trim();
                            let char = project.characters.find(c => c.name.toLowerCase() === charName.toLowerCase());
                            if (!char) { char = { id: nextId.character++, name: charName, prompt: `Un personaje llamado ${charName}`, color: '#cccccc', referenceImages: [] }; project.characters.push(char); }
                            if(char) currentPanel.characterIds.push(char.id);
                        });
                    } else if (poseMatch && currentPanel) { /* Similar logic for poses */ }
                    else if (clothingMatch && currentPanel) { /* Similar logic for clothing */ }
                    else if (promptMatch && currentPanel) { currentPanel.prompt = promptMatch[1].trim(); }
                    else if (dialogueMatch && currentPage) {
                        const charName = dialogueMatch[1].trim();
                        const dialogueText = dialogueMatch[2].trim();
                        currentPage.texts.push({ id: nextId.text++, type: 'dialogue', text: dialogueText, className: 'speech-bubble', font: "'Comic Neue', cursive", size: 16, x: 10, y: 10, rotation: 0, zIndex: 10 });
                    }
                });
                alert('Guion importado. Revisa las páginas y recursos creados.');
                activePageIndex = 0;
                updateAndSave();
            }

            // --- EVENT LISTENERS ---
            function setupModal(btnId, modalId, formId, cancelId, onShow = () => {}) { const modal = getEl(modalId); getEl(btnId).addEventListener('click', () => { getEl(formId).reset(); onShow(); modal.classList.remove('hidden'); }); getEl(cancelId).addEventListener('click', () => modal.classList.add('hidden')); modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); }); };
            function renderImageGallery(galleryEl, imagesArray) { galleryEl.innerHTML = ''; if (imagesArray.length === 0) { galleryEl.innerHTML = '<p class="text-gray-500 text-sm col-span-full text-center">Sin imágenes de referencia.</p>'; } else { imagesArray.forEach((imgSrc, index) => { const thumb = document.createElement('div'); thumb.className = 'ref-image-thumb aspect-square bg-gray-700 rounded-md'; thumb.innerHTML = `<img src="${imgSrc}" class="w-full h-full object-contain rounded-md"><button data-index="${index}" class="delete-ref-image-btn"><i data-lucide="x" class="w-4 h-4 text-white pointer-events-none"></i></button>`; galleryEl.appendChild(thumb); }); } lucide.createIcons(); }

            // Modals Setup (Character, Clothing, Background, Pose)
            characterModal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4"><h3 id="character-modal-title" class="text-xl font-bold mb-4"></h3><form id="character-form"><input type="hidden" id="character-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><label for="character-name" class="block text-sm font-medium text-gray-300">Nombre</label><input type="text" id="character-name" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" required><label for="character-prompt" class="block text-sm font-medium text-gray-300">Descripción (Prompt)</label><textarea id="character-prompt" rows="6" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" required></textarea><label for="character-color" class="block text-sm font-medium text-gray-300">Color</label><input type="color" id="character-color" value="#3b82f6" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-md"></div><div class="space-y-4"><label class="block text-sm font-medium text-gray-300">Imágenes de Referencia</label><div id="character-image-gallery" class="w-full min-h-[150px] bg-gray-900/50 p-2 rounded-md grid grid-cols-3 gap-2"></div><input type="file" id="character-image-upload" class="hidden" accept="image/*" multiple><button type="button" id="upload-character-image-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Añadir Imagen(es)</button></div></div><div class="flex justify-end space-x-3 mt-6"><button type="button" id="cancel-character-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar</button></div></form></div>`;
            setupModal('add-character-btn', 'character-modal', 'character-form', 'cancel-character-btn', () => { getEl('character-modal-title').innerText = 'Añadir Nuevo Personaje'; getEl('character-id').value = ''; tempImages = []; renderImageGallery(getEl('character-image-gallery'), tempImages); });
            getEl('character-form').addEventListener('submit', (e) => { e.preventDefault(); const id = getEl('character-id').value; const charData = { name: getEl('character-name').value, prompt: getEl('character-prompt').value, color: getEl('character-color').value, referenceImages: [...tempImages] }; if (id) { Object.assign(project.characters.find(c => c.id === parseInt(id)), charData); } else { project.characters.push({ id: nextId.character++, ...charData }); } characterModal.classList.add('hidden'); updateAndSave(); });
            getEl('upload-character-image-btn').addEventListener('click', () => getEl('character-image-upload').click());
            getEl('character-image-upload').addEventListener('change', (e) => { if (e.target.files) { Array.from(e.target.files).forEach(file => { const reader = new FileReader(); reader.onload = (event) => { tempImages.push(event.target.result); renderImageGallery(getEl('character-image-gallery'), tempImages); }; reader.readAsDataURL(file); }); } });
            characterModal.addEventListener('click', (e) => { if (e.target.closest('.delete-ref-image-btn')) { const index = parseInt(e.target.closest('.delete-ref-image-btn').dataset.index); tempImages.splice(index, 1); renderImageGallery(getEl('character-image-gallery'), tempImages); } });
            
            const setupAssetModal = (type, modal, buttonId) => {
                modal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 relative"><h3 id="${type}-modal-title" class="text-xl font-bold mb-4"></h3><form id="${type}-form"><input type="hidden" id="${type}-id"><input type="file" id="${type}-image-upload" class="hidden" accept="image/*"><div class="mb-4"><label for="${type}-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="${type}-name" class="w-full bg-gray-700 rounded-md px-3 py-2 text-white" required></div><div class="mb-4"><label for="${type}-prompt" class="block text-sm font-medium text-gray-300 mb-1">Descripción</label><textarea id="${type}-prompt" rows="3" class="w-full bg-gray-700 rounded-md px-3 py-2 text-white" required></textarea></div><button type="button" id="generate-${type}-image-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generar Imagen</button><button type="button" id="upload-${type}-image-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Subir Imagen</button><div class="mb-4 mt-4"><label class="block text-sm font-medium text-gray-300 mb-1">Imagen de Referencia</label><div class="w-full h-40 bg-gray-700 rounded-md flex items-center justify-center"><img id="${type}-image-preview" src="https://placehold.co/400x200/374151/9ca3af?text=Genera+una+imagen" class="max-w-full max-h-full object-contain rounded-md"></div></div><div class="flex justify-end space-x-3"><button type="button" id="cancel-${type}-btn" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Cancelar</button><button type="submit" id="save-${type}-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Guardar</button></div></form></div>`;
                setupModal(buttonId, `${type}-modal`, `${type}-form`, `cancel-${type}-btn`, () => { getEl(`${type}-modal-title`).innerText = `Añadir ${type === 'pose' ? 'Pose/Objeto' : 'Prenda/Accesorio'}`; getEl(`${type}-id`).value = ''; getEl(`${type}-image-preview`).src = 'https://placehold.co/400x200/374151/9ca3af?text=Genera+una+imagen'; getEl(`save-${type}-btn`).disabled = true; });
                
                getEl(`upload-${type}-image-btn`).addEventListener('click', () => getEl(`${type}-image-upload`).click());
                getEl(`${type}-image-upload`).addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            getEl(`${type}-image-preview`).src = event.target.result;
                            getEl(`save-${type}-btn`).disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                getEl(`generate-${type}-image-btn`).addEventListener('click', async (e) => { const form = e.target.closest('form'); const promptText = form.querySelector(`#${type}-prompt`).value; if (!promptText) return; const modalContent = form.parentElement; modalContent.classList.add('modal-generating'); const payload = { instances: [{ prompt: `Estilo de cómic, objeto aislado, fondo blanco. ${promptText}` }], parameters: { "sampleCount": 1 } }; const imageUrl = await callApi(imagenApiUrl, payload, true); modalContent.classList.remove('modal-generating'); if (imageUrl) { form.querySelector(`#${type}-image-preview`).src = imageUrl; form.querySelector(`#save-${type}-btn`).disabled = false; } });
                getEl(`${type}-form`).addEventListener('submit', (e) => { e.preventDefault(); const id = getEl(`${type}-id`).value; const itemData = { name: getEl(`${type}-name`).value, prompt: getEl(`${type}-prompt`).value, referenceImage: getEl(`${type}-image-preview`).src }; if (id) { Object.assign(project[type === 'pose' ? 'poses' : 'clothing'].find(c => c.id === parseInt(id)), itemData); } else { project[type === 'pose' ? 'poses' : 'clothing'].push({ id: nextId[type]++, ...itemData }); } modal.classList.add('hidden'); updateAndSave(); });
            };
            setupAssetModal('clothing', clothingModal, 'add-clothing-btn');
            setupAssetModal('pose', poseModal, 'add-pose-btn');
            
            backgroundModal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 relative"><h3 id="background-modal-title" class="text-xl font-bold mb-4"></h3><form id="background-form"><input type="hidden" id="background-id"><input type="file" id="background-image-upload" class="hidden" accept="image/*"><div class="mb-4"><label for="background-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="background-name" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" required></div><div class="mb-4"><label for="background-prompt" class="block text-sm font-medium text-gray-300 mb-1">Descripción</label><textarea id="background-prompt" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" required></textarea></div><button type="button" id="generate-background-image-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generar Imagen de Fondo</button><button type="button" id="upload-background-image-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i data-lucide="upload" class="w-4 h-4 mr-2"></i>Subir Imagen</button><div class="mb-4 mt-4"><label class="block text-sm font-medium text-gray-300 mb-1">Imagen de Referencia</label><div class="w-full h-40 bg-gray-700 rounded-md flex items-center justify-center"><img id="background-image-preview" src="https://placehold.co/400x200/374151/9ca3af?text=Genera+una+imagen" class="max-w-full max-h-full object-contain rounded-md"></div></div><div class="flex justify-end space-x-3"><button type="button" id="cancel-background-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" id="save-background-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Guardar</button></div></form></div>`;
            setupModal('add-background-btn', 'background-modal', 'background-form', 'cancel-background-btn', () => { getEl('background-modal-title').innerText = 'Añadir Nuevo Fondo'; getEl('background-id').value = ''; getEl('background-image-preview').src = 'https://placehold.co/400x200/374151/9ca3af?text=Genera+una+imagen'; getEl('save-background-btn').disabled = true; });
            getEl('upload-background-image-btn').addEventListener('click', () => getEl('background-image-upload').click());
            getEl('background-image-upload').addEventListener('change', e => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        getEl('background-image-preview').src = event.target.result;
                        getEl('save-background-btn').disabled = false;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            getEl('generate-background-image-btn').addEventListener('click', async (e) => { const form = e.target.closest('form'); const prompt = form.querySelector('#background-prompt').value; if (!prompt) { alert('Introduce una descripción.'); return; } const modalContent = form.parentElement; modalContent.classList.add('modal-generating'); const currentBgId = parseInt(getEl('background-id').value || '0'); const styleReferenceBgs = project.backgrounds.filter(bg => bg.referenceImage && bg.id !== currentBgId); let imageUrl; if (styleReferenceBgs.length > 0) { let parts = []; let instruction = "Genera una imagen de fondo para un cómic. Las siguientes imágenes son referencias de estilo. Mantén una paleta de colores y un estilo artístico coherente con ellas. "; const refsToUse = styleReferenceBgs.slice(0, 2); const imageIndices = []; refsToUse.forEach(bg => { imageIndices.push(parts.length + 1); parts.push({ inlineData: { mimeType: `image/${bg.referenceImage.split(';')[0].split('/')[1]}`, data: bg.referenceImage.split(',')[1] } }); }); instruction += `Las imágenes ${imageIndices.join(' y ')} son las referencias de estilo.`; parts.unshift({ text: instruction }); parts.push({ text: `Descripción del nuevo fondo: ${prompt}` }); const payload = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } }; imageUrl = await callApi(flashApiUrl, payload, false); } else { const payload = { instances: [{ prompt: `Estilo de cómic, paisaje. ${prompt}` }], parameters: { "sampleCount": 1 } }; imageUrl = await callApi(imagenApiUrl, payload, true); } modalContent.classList.remove('modal-generating'); if (imageUrl) { form.querySelector('#background-image-preview').src = imageUrl; form.querySelector('#save-background-btn').disabled = false; } else { alert('No se pudo generar la imagen.'); } });
            getEl('background-form').addEventListener('submit', (e) => { e.preventDefault(); const id = getEl('background-id').value; const bgData = { name: getEl('background-name').value, prompt: getEl('background-prompt').value, referenceImage: getEl('background-image-preview').src }; if (id) Object.assign(project.backgrounds.find(b => b.id === parseInt(id)), bgData); else project.backgrounds.push({ id: nextId.background++, ...bgData }); backgroundModal.classList.add('hidden'); updateAndSave(); });
            
            editPanelModal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl mx-4 relative animate-fade-in">
                <h3 class="text-xl font-bold mb-4">Editar Viñeta</h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <div id="edit-image-container" class="flex-grow h-[50vh] bg-gray-900/50 rounded-md flex items-center justify-center mb-4 overflow-hidden">
                        <img id="edit-image-preview" src="" class="max-w-full max-h-full block">
                    </div>
                    <div class="w-full md:w-1/3">
                         <h4 class="text-sm font-semibold text-gray-400 mb-2">Referencias de Personaje para IA</h4>
                         <div id="edit-panel-references-gallery" class="w-full h-[50vh] bg-gray-900/50 p-2 rounded-md overflow-y-auto grid grid-cols-2 gap-2">
                            <!-- Thumbnails will be injected here -->
                         </div>
                    </div>
                </div>
                <div id="ai-edit-section" class="border-t border-gray-700 pt-4 mt-4">
                    <label for="edit-prompt" class="block text-sm font-medium text-gray-300 mb-1">Instrucción de Edición (IA)</label>
                    <textarea id="edit-prompt" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white mb-2" placeholder="Ej: Cambia la camisa a color rojo..."></textarea>
                    <button id="generate-edit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i>Generar Edición</button>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="button" id="crop-and-create-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2"><i data-lucide="crop" class="w-4 h-4"></i><span>Recortar y Crear Viñeta</span></button>
                    <button type="button" id="save-edit-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Guardar Edición IA</button>
                </div>
            </div>`;
            
             function closeEditModal() { if (cropper) { cropper.destroy(); cropper = null; } editPanelModal.classList.add('hidden'); }
            getEl('cancel-edit-btn').addEventListener('click', closeEditModal);
            getEl('generate-edit-btn').addEventListener('click', async (e) => { 
                const prompt = getEl('edit-prompt').value; 
                if (!prompt) { alert('Introduce una instrucción de edición.'); return; } 
                const originalImage = getEl('edit-image-preview').src;
                
                const panel = project.pages[activePageIndex].panels.find(p => p.id === currentlyEditingPanelId);
                const characterIds = panel ? panel.characterIds : [];

                const modalContent = e.target.closest('.bg-gray-800'); 
                modalContent.classList.add('modal-generating'); 
                const newImage = await editImage(originalImage, prompt, characterIds); 
                modalContent.classList.remove('modal-generating'); 
                if (newImage) {
                    editedImageUrl = newImage;
                    getEl('save-edit-btn').disabled = false;
                
                    const editImagePreview = getEl('edit-image-preview');
                
                    // Siempre destruye la instancia anterior para evitar conflictos
                    if (cropper) {
                        cropper.destroy();
                    }
                
                    // Espera a que la nueva imagen se cargue ANTES de inicializar Cropper.js
                    editImagePreview.onload = () => {
                        cropper = new Cropper(editImagePreview, {
                            viewMode: 1,
                            background: false,
                            autoCropArea: 0.9
                        });
                    };
                
                    // Pide al <img> que cargue la nueva imagen. Esto disparará el 'onload'.
                    editImagePreview.src = newImage;
                } else { 
                    alert('No se pudo editar la imagen.'); 
                } 
            });
            getEl('save-edit-btn').addEventListener('click', () => { if (currentlyEditingPanelId && editedImageUrl) { const panel = project.pages[activePageIndex].panels.find(p => p.id === currentlyEditingPanelId); panel.imageUrl = editedImageUrl; closeEditModal(); updateAndSave(); } });
            getEl('crop-and-create-btn').addEventListener('click', () => { if (!cropper || !currentlyEditingPanelId) return; const croppedImageUrl = cropper.getCroppedCanvas({ fillColor: '#fff' }).toDataURL('image/png'); const panelIndex = project.pages[activePageIndex].panels.findIndex(p => p.id === currentlyEditingPanelId); if (panelIndex === -1) return; const panelToCopy = project.pages[activePageIndex].panels[panelIndex]; const newPanel = JSON.parse(JSON.stringify(panelToCopy)); newPanel.id = nextId.panel++; newPanel.imageUrl = croppedImageUrl; newPanel.transform = { zoom: 1, panX: 50, panY: 50 }; project.pages[activePageIndex].panels.splice(panelIndex + 1, 0, newPanel); closeEditModal(); updateAndSave(); });

            dialogueModal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4"><h3 id="dialogue-modal-title" class="text-xl font-bold mb-4"></h3><form id="dialogue-form"><input type="hidden" id="dialogue-id"><div class="space-y-4"><label for="dialogue-text" class="block text-sm font-medium text-gray-300">Texto</label><textarea id="dialogue-text" rows="3" class="w-full bg-gray-700 rounded-md p-2" required></textarea><label for="dialogue-style" class="block text-sm font-medium text-gray-300">Estilo de Bocadillo</label><select id="dialogue-style" class="w-full bg-gray-700 rounded-md p-2"><option value="speech-bubble">Normal</option><option value="thought-bubble">Pensamiento</option><option value="scream-bubble">Grito</option></select><label for="dialogue-font" class="block text-sm font-medium text-gray-300">Fuente</label><select id="dialogue-font" class="w-full bg-gray-700 rounded-md p-2"><option value="'Comic Neue', cursive">Comic Neue</option><option value="'Inter', sans-serif">Inter</option></select></div><div class="flex justify-end space-x-3 mt-6"><button type="button" id="cancel-dialogue-btn" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-yellow-600 hover:bg-yellow-700 py-2 px-4 rounded-lg">Guardar</button></div></form></div>`;
            getEl('add-dialogue-btn').addEventListener('click', () => { currentlyEditingTextId = null; getEl('dialogue-form').reset(); getEl('dialogue-modal-title').textContent = "Añadir Diálogo"; dialogueModal.classList.remove('hidden'); });
            getEl('cancel-dialogue-btn').addEventListener('click', () => dialogueModal.classList.add('hidden'));
            getEl('dialogue-form').addEventListener('submit', (e) => { e.preventDefault(); const textData = { type: 'dialogue', text: getEl('dialogue-text').value, className: getEl('dialogue-style').value, font: getEl('dialogue-font').value, size: 16, x: 10, y: 10, rotation: 0, zIndex: 10 }; const texts = project.pages[activePageIndex].texts; if (currentlyEditingTextId) { const existing = texts.find(t => t.id === currentlyEditingTextId); Object.assign(existing, textData); } else { textData.zIndex = (texts.length + 1) * 10; texts.push({ id: nextId.text++, ...textData }); } dialogueModal.classList.add('hidden'); updateAndSave(); });
            sfxModal.innerHTML = `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4"><h3 id="sfx-modal-title" class="text-xl font-bold mb-4"></h3><form id="sfx-form"><input type="hidden" id="sfx-id"><div class="space-y-4"><label for="sfx-text" class="block text-sm font-medium text-gray-300">Texto (ej. BOOM!)</label><input type="text" id="sfx-text" class="w-full bg-gray-700 rounded-md p-2" required><label for="sfx-style" class="block text-sm font-medium text-gray-300">Estilo Visual</label><select id="sfx-style" class="w-full bg-gray-700 rounded-md p-2"><option value="sfx-style-1">Impacto</option><option value="sfx-style-2">Terror</option><option value="sfx-style-3">Acción</option></select><label for="sfx-size" class="block text-sm font-medium text-gray-300">Tamaño</label><input type="range" id="sfx-size" min="24" max="96" value="48" class="w-full"></div><div class="flex justify-end space-x-3 mt-6"><button type="button" id="cancel-sfx-btn" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg">Guardar</button></div></form></div>`;
            getEl('add-sfx-btn').addEventListener('click', () => { currentlyEditingTextId = null; getEl('sfx-form').reset(); getEl('sfx-modal-title').textContent = "Añadir Onomatopeya"; sfxModal.classList.remove('hidden'); });
            getEl('cancel-sfx-btn').addEventListener('click', () => sfxModal.classList.add('hidden'));
            getEl('sfx-form').addEventListener('submit', (e) => { e.preventDefault(); const textData = { type: 'sfx', text: getEl('sfx-text').value, className: getEl('sfx-style').value, size: getEl('sfx-size').value, x: 15, y: 15, rotation: -10, zIndex: 10 }; const texts = project.pages[activePageIndex].texts; if (currentlyEditingTextId) { const existing = texts.find(t => t.id === currentlyEditingTextId); Object.assign(existing, textData); } else { textData.zIndex = (texts.length + 1) * 10; texts.push({ id: nextId.text++, ...textData }); } sfxModal.classList.add('hidden'); updateAndSave(); });
            
            getEl('panel-image-upload').addEventListener('change', e => {
                if (e.target.files && e.target.files[0] && currentlyUploadingToPanelId !== null) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const panel = project.pages[activePageIndex].panels.find(p => p.id === currentlyUploadingToPanelId);
                        if (panel) {
                            panel.imageUrl = event.target.result;
                            updateAndSave();
                        }
                        currentlyUploadingToPanelId = null;
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = null;
            });
            getEl('layer-image-upload').addEventListener('change', e => {
                if (e.target.files && e.target.files[0] && currentlyUploadingToLayerId) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const panel = project.pages[activePageIndex].overlayPanels.find(p => p.id === currentlyUploadingToLayerId);
                        if (panel) {
                            panel.imageUrl = event.target.result;
                            updateAndSave();
                        }
                        currentlyUploadingToLayerId = null;
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = null;
            });
            // Dragging Logic, double click, layer controls for Text Elements
            let dragTarget = null; let offset = {x: 0, y: 0};
            textOverlay.addEventListener('mousedown', e => {
                const target = e.target.closest('.text-overlay-element');
                if(target) {
                    selectTextElement(target);
                    dragTarget = target; const rect = dragTarget.getBoundingClientRect(); offset.x = e.clientX - rect.left; offset.y = e.clientY - rect.top; dragTarget.classList.add('dragging');
                    document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
                } else { unselectTextElement(); }
            });
            function onMouseMove(e) { if(!dragTarget) return; e.preventDefault(); const containerRect = textOverlay.getBoundingClientRect(); let x = e.clientX - offset.x - containerRect.left; let y = e.clientY - offset.y - containerRect.top; dragTarget.style.left = `${(x / containerRect.width) * 100}%`; dragTarget.style.top = `${(y / containerRect.height) * 100}%`; }
            function onMouseUp() { if(dragTarget) { const textId = parseInt(dragTarget.dataset.textId); const textItem = project.pages[activePageIndex].texts.find(t => t.id === textId); textItem.x = parseFloat(dragTarget.style.left); textItem.y = parseFloat(dragTarget.style.top); dragTarget.classList.remove('dragging'); debouncedAutosave(); } dragTarget = null; document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); }
            textOverlay.addEventListener('dblclick', e => { const target = e.target.closest('.text-overlay-element'); if (target) { const textId = parseInt(target.dataset.textId); const textItem = project.pages[activePageIndex].texts.find(t => t.id === textId); currentlyEditingTextId = textId; if (textItem.type === 'dialogue') { getEl('dialogue-modal-title').textContent = "Editar Diálogo"; getEl('dialogue-id').value = textItem.id; getEl('dialogue-text').value = textItem.text; getEl('dialogue-style').value = textItem.className; getEl('dialogue-font').value = textItem.font; dialogueModal.classList.remove('hidden'); } else if (textItem.type === 'sfx') { getEl('sfx-modal-title').textContent = "Editar Onomatopeya"; getEl('sfx-id').value = textItem.id; getEl('sfx-text').value = textItem.text; getEl('sfx-style').value = textItem.className; getEl('sfx-size').value = textItem.size; sfxModal.classList.remove('hidden'); } } });
            function selectTextElement(element) { unselectTextElement(); selectedTextElement = element; selectedTextElement.classList.add('selected'); textLayerControls.classList.remove('hidden'); }
            function unselectTextElement() { if (selectedTextElement) { selectedTextElement.classList.remove('selected'); } selectedTextElement = null; textLayerControls.classList.add('hidden'); }
            getEl('bring-front-btn').addEventListener('click', () => { if (!selectedTextElement) return; const textId = parseInt(selectedTextElement.dataset.textId); const texts = project.pages[activePageIndex].texts; const itemIndex = texts.findIndex(t => t.id === textId); if (itemIndex < texts.length - 1) { const item = texts.splice(itemIndex, 1)[0]; texts.push(item); texts.forEach((t, i) => t.zIndex = (i + 1) * 10); updateAndSave(); selectTextElement(textOverlay.querySelector(`[data-text-id="${textId}"]`)); } });
            getEl('send-back-btn').addEventListener('click', () => { if (!selectedTextElement) return; const textId = parseInt(selectedTextElement.dataset.textId); const texts = project.pages[activePageIndex].texts; const itemIndex = texts.findIndex(t => t.id === textId); if (itemIndex > 0) { const item = texts.splice(itemIndex, 1)[0]; texts.unshift(item); texts.forEach((t, i) => t.zIndex = (i + 1) * 10); updateAndSave(); selectTextElement(textOverlay.querySelector(`[data-text-id="${textId}"]`)); } });
            getEl('delete-text-btn').addEventListener('click', () => { if (!selectedTextElement) return; const textId = parseInt(selectedTextElement.dataset.textId); project.pages[activePageIndex].texts = project.pages[activePageIndex].texts.filter(t => t.id !== textId); unselectTextElement(); updateAndSave(); });

             // --- OVERLAY PANEL DRAG/RESIZE ---
            let dragOverlayTarget = null, resizeOverlayTarget = null, overlayOffset = { x: 0, y: 0 }, startSize = { width: 0, height: 0 }, startPos = { x: 0, y: 0 };
            overlayPanelLayer.addEventListener('mousedown', e => {
                unselectTextElement();
                const resizer = e.target.closest('.resizer');
                const panelEl = e.target.closest('.overlay-panel');
                if (resizer) {
                    e.preventDefault(); e.stopPropagation();
                    resizeOverlayTarget = panelEl;
                    const rect = panelEl.getBoundingClientRect();
                    startSize = { width: rect.width, height: rect.height };
                    startPos = { x: e.clientX, y: e.clientY };
                    document.addEventListener('mousemove', onOverlayResize); document.addEventListener('mouseup', onOverlayResizeEnd);
                } else if (panelEl) {
                    selectedOverlayPanelId = panelEl.dataset.overlayPanelId;
                    
                    // Manually handle selection without a full re-render to fix drag bug
                    overlayPanelLayer.querySelectorAll('.overlay-panel').forEach(p => p.classList.remove('selected'));
                    panelEl.classList.add('selected');
                    overlayPanelsList.querySelectorAll('.panel-card').forEach(p => p.classList.remove('selected-panel'));
                    const listCard = overlayPanelsList.querySelector(`.panel-card[data-overlay-panel-id="${selectedOverlayPanelId}"]`);
                    if(listCard) listCard.classList.add('selected-panel');

                    dragOverlayTarget = panelEl;
                    const rect = dragOverlayTarget.getBoundingClientRect();
                    overlayOffset.x = e.clientX - rect.left;
                    overlayOffset.y = e.clientY - rect.top;
                    dragOverlayTarget.classList.add('dragging');
                    document.addEventListener('mousemove', onOverlayDrag); document.addEventListener('mouseup', onOverlayDragEnd);
                } else {
                    selectedOverlayPanelId = null;
                    overlayPanelLayer.querySelectorAll('.overlay-panel').forEach(p => p.classList.remove('selected'));
                    overlayPanelsList.querySelectorAll('.panel-card').forEach(p => p.classList.remove('selected-panel'));
                }
            });
            function onOverlayDrag(e) { if(!dragOverlayTarget) return; e.preventDefault(); const containerRect = overlayPanelLayer.getBoundingClientRect(); let x = e.clientX - overlayOffset.x - containerRect.left; let y = e.clientY - overlayOffset.y - containerRect.top; dragOverlayTarget.style.left = `${(x / containerRect.width) * 100}%`; dragOverlayTarget.style.top = `${(y / containerRect.height) * 100}%`; }
            function onOverlayDragEnd() { if (dragOverlayTarget) { const panelId = dragOverlayTarget.dataset.overlayPanelId; const panel = project.pages[activePageIndex].overlayPanels.find(p => p.id === panelId); panel.x = parseFloat(dragOverlayTarget.style.left); panel.y = parseFloat(dragOverlayTarget.style.top); dragOverlayTarget.classList.remove('dragging'); debouncedAutosave(); } dragOverlayTarget = null; document.removeEventListener('mousemove', onOverlayDrag); document.removeEventListener('mouseup', onOverlayDragEnd); }
            function onOverlayResize(e) { if (!resizeOverlayTarget) return; e.preventDefault(); const dx = e.clientX - startPos.x; const dy = e.clientY - startPos.y; resizeOverlayTarget.style.width = `${startSize.width + dx}px`; resizeOverlayTarget.style.height = `${startSize.height + dy}px`; }
            function onOverlayResizeEnd() { if (resizeOverlayTarget) { const panelId = resizeOverlayTarget.dataset.overlayPanelId; const panel = project.pages[activePageIndex].overlayPanels.find(p => p.id === panelId); panel.width = parseFloat(resizeOverlayTarget.style.width); panel.height = parseFloat(resizeOverlayTarget.style.height); debouncedAutosave(); } resizeOverlayTarget = null; document.removeEventListener('mousemove', onOverlayResize); document.removeEventListener('mouseup', onOverlayResizeEnd); }

            // ===================================================================
            // --- REFACTORED & NEW EVENT LISTENERS ---
            // ===================================================================

            // Listener for closing popovers/modals on outside clicks
            document.addEventListener('click', e => {
                if (!e.target.closest('#auto-layout-btn') && !e.target.closest('#layout-popover')) {
                    layoutPopover.classList.add('hidden');
                }
                const cardModal = getEl('character-card-modal');
                if (e.target.id === 'character-card-modal' || e.target.closest('#close-character-card-btn')) {
                    cardModal.classList.add('hidden');
                }
                 if (!e.target.closest('#file-menu-btn') && !e.target.closest('#file-dropdown')) {
                    getEl('file-dropdown').classList.add('hidden');
                }
                if (!e.target.closest('.upscale-panel-btn, .upscale-overlay-btn') && !e.target.closest('.upscale-options')) {
                    document.querySelectorAll('.upscale-options').forEach(el => el.classList.add('hidden'));
                }
            });

            // Delegated listener for the entire control panel
            getEl('control-panel').addEventListener('click', e => {
                const selectedPanelEl = panelsList.querySelector('.selected-panel');
                const activePanel = selectedPanelEl ? project.pages[activePageIndex].panels.find(p => p.id === parseInt(selectedPanelEl.dataset.panelId)) : null;

                const handleAssetClick = (type, id, action) => {
                    const collection = project[type];
                    const idKey = type.slice(0, -1) + 'Id';
                    
                    if (action === 'delete') {
                        project[type] = collection.filter(item => item.id !== id);
                        project.pages.forEach(page => page.panels.forEach(p => {
                            if (p[idKey] === id) p[idKey] = null;
                            if (p[type + 'Ids']) p[type + 'Ids'] = p[type + 'Ids'].filter(cid => cid !== id);
                        }));
                    } else if (action === 'edit') {
                        const item = collection.find(c => c.id === id);
                        if (type === 'characters') {
                            getEl('character-modal-title').innerText = 'Editar Personaje'; getEl('character-id').value = item.id; getEl('character-name').value = item.name; getEl('character-prompt').value = item.prompt; getEl('character-color').value = item.color; tempImages = [...(item.referenceImages || [])]; renderImageGallery(getEl('character-image-gallery'), tempImages); characterModal.classList.remove('hidden');
                        } else {
                           const modalType = type === 'poses' ? 'pose' : (type === 'clothing' ? 'clothing' : 'background');
                           getEl(`${modalType}-modal-title`).innerText = `Editar ${modalType === 'pose' ? 'Pose/Objeto' : (modalType === 'clothing' ? 'Prenda/Accesorio' : 'Fondo')}`;
                           getEl(`${modalType}-id`).value = item.id; getEl(`${modalType}-name`).value = item.name; getEl(`${modalType}-prompt`).value = item.prompt; getEl(`${modalType}-image-preview`).src = item.referenceImage || `https://placehold.co/400x200/374151/9ca3af?text=Genera+una+imagen`; getEl(`save-${modalType}-btn`).disabled = !item.referenceImage; getEl(`${modalType}-modal`).classList.remove('hidden');
                        }
                    } else if (action === 'show-card') {
                        showCharacterCard(id);
                    }
                    updateAndSave();
                };

                const assetActions = [
                    { selector: '.show-character-card-btn', type: 'characters', action: 'show-card' }, { selector: '.edit-character-btn', type: 'characters', action: 'edit' }, { selector: '.delete-character-btn', type: 'characters', action: 'delete' },
                    { selector: '.edit-background-btn', type: 'backgrounds', action: 'edit' }, { selector: '.delete-background-btn', type: 'backgrounds', action: 'delete' },
                    { selector: '.edit-clothing-btn', type: 'clothing', action: 'edit' }, { selector: '.delete-clothing-btn', type: 'clothing', action: 'delete' },
                    { selector: '.edit-pose-btn', type: 'poses', action: 'edit' }, { selector: '.delete-pose-btn', type: 'poses', action: 'delete' },
                ];
                for (const { selector, type, action } of assetActions) {
                    const btn = e.target.closest(selector);
                    if (btn) { handleAssetClick(type, parseInt(btn.dataset.id), action); return; }
                }

                if (activePanel) {
                     const assetTags = [
                        { selector: '.character-tag', idKey: 'characterId', collectionKey: 'characterIds' }, { selector: '.asset-tag[data-background-id]', idKey: 'backgroundId', collectionKey: 'backgroundId' },
                        { selector: '.asset-tag[data-clothing-id]', idKey: 'clothingId', collectionKey: 'clothingIds' }, { selector: '.asset-tag[data-pose-id]', idKey: 'poseId', collectionKey: 'poseIds' },
                    ];
                    for (const { selector, idKey, collectionKey } of assetTags) {
                        const tag = e.target.closest(selector);
                        if (tag) {
                            const id = parseInt(tag.dataset[idKey]);
                            if (collectionKey === 'backgroundId') {
                                activePanel.backgroundId = activePanel.backgroundId === id ? null : id;
                            } else {
                                if (activePanel[collectionKey].includes(id)) { activePanel[collectionKey] = activePanel[collectionKey].filter(cid => cid !== id); } 
                                else { activePanel[collectionKey].push(id); }
                            }
                            updateAndSave(); return;
                        }
                    }
                }
            });

            // Character Card Modal specific actions
            getEl('character-card-modal').addEventListener('click', async e => {
                const genSheetBtn = e.target.closest('#generate-character-sheet-btn');
                const addSheetBtn = e.target.closest('.add-sheet-to-gallery-btn');
                if (genSheetBtn) {
                    const characterId = parseInt(genSheetBtn.dataset.characterId);
                    const character = project.characters.find(c => c.id === characterId);
                    if (character) await generateCharacterSheet(character);
                } else if (addSheetBtn) {
                    const characterId = parseInt(addSheetBtn.dataset.characterId);
                    const imageUrl = addSheetBtn.dataset.imageUrl;
                    const character = project.characters.find(c => c.id === characterId);
                    if (character && imageUrl) {
                        if (!character.referenceImages) character.referenceImages = [];
                        character.referenceImages.push(imageUrl);
                        showCharacterCard(characterId);
                        addSheetBtn.disabled = true; addSheetBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5 pointer-events-none"></i>'; lucide.createIcons();
                        autosaveProject();
                    }
                }
            });

            // Page management
            addPageBtn.addEventListener('click', () => { project.pages.push({ id: nextId.page++, panels: [], overlayPanels: [], texts: [], layout: 'default', backgroundColor: '#ffffff' }); activePageIndex = project.pages.length - 1; selectedPanelId = null; selectedOverlayPanelId = null; updateAndSave(); });
            pagesList.addEventListener('click', e => { 
                const pageThumb = e.target.closest('.page-thumb');
                const deleteBtn = e.target.closest('.delete-page-btn');
                if (pageThumb && !deleteBtn) { 
                    activePageIndex = parseInt(pageThumb.dataset.pageIndex); 
                    selectedPanelId = null; 
                    selectedOverlayPanelId = null; 
                    render(); 
                } 
                if (deleteBtn) { 
                    e.stopPropagation(); // Prevents the page selection click
                    const indexToDelete = parseInt(deleteBtn.dataset.pageIndex); 
                    if (project.pages.length > 1) { 
                        project.pages.splice(indexToDelete, 1);
                        let newActiveIndex = activePageIndex;
                        if (activePageIndex === indexToDelete) {
                            newActiveIndex = Math.max(0, indexToDelete - 1);
                        } else if (activePageIndex > indexToDelete) {
                            newActiveIndex = activePageIndex - 1;
                        }
                        activePageIndex = newActiveIndex;
                        selectedPanelId = null; 
                        selectedOverlayPanelId = null; 
                        updateAndSave(); 
                    } 
                } 
            });

            // Page drag and drop reordering
            let draggedPageIndex = null;
            let pagePlaceholder = null;

            function createPagePlaceholder() {
                if (!pagePlaceholder) {
                    pagePlaceholder = document.createElement('div');
                    pagePlaceholder.className = 'drop-placeholder flex-shrink-0 w-24 h-16';
                }
                return pagePlaceholder;
            }

            pagesList.addEventListener('dragstart', e => {
                const pageThumb = e.target.closest('.page-thumb');
                if (pageThumb) {
                    draggedPageIndex = parseInt(pageThumb.dataset.pageIndex);
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => {
                        pageThumb.classList.add('dragging');
                    }, 0);
                }
            });

            pagesList.addEventListener('dragend', () => {
                document.querySelectorAll('.page-thumb.dragging').forEach(el => el.classList.remove('dragging'));
                if (pagePlaceholder && pagePlaceholder.parentElement) {
                    pagePlaceholder.parentElement.removeChild(pagePlaceholder);
                }
                pagePlaceholder = null;
                draggedPageIndex = null;
            });

            pagesList.addEventListener('dragover', e => {
                e.preventDefault();
                const ph = createPagePlaceholder();
                const targetThumb = e.target.closest('.page-thumb:not(.dragging)');
                if (targetThumb) {
                    const rect = targetThumb.getBoundingClientRect();
                    const isAfter = (e.clientX - rect.left) / rect.width > 0.5;
                    if (isAfter) {
                        targetThumb.parentNode.insertBefore(ph, targetThumb.nextSibling);
                    } else {
                        targetThumb.parentNode.insertBefore(ph, targetThumb);
                    }
                } else if (!pagesList.querySelector('.drop-placeholder') && pagesList.querySelector('.dragging')) {
                    pagesList.appendChild(ph);
                }
            });

            pagesList.addEventListener('drop', e => {
                e.preventDefault();
                if (draggedPageIndex === null) return;
                const placeholder = pagesList.querySelector('.drop-placeholder');
                if (!placeholder) return;

                const children = Array.from(pagesList.children);
                const newIndex = children.indexOf(placeholder);

                const pageToMove = project.pages.splice(draggedPageIndex, 1)[0];
                project.pages.splice(newIndex, 0, pageToMove);
                
                if (activePageIndex === draggedPageIndex) {
                    activePageIndex = newIndex;
                } else if (draggedPageIndex < activePageIndex && newIndex >= activePageIndex) {
                    activePageIndex--;
                } else if (draggedPageIndex > activePageIndex && newIndex <= activePageIndex) {
                    activePageIndex++;
                }
                updateAndSave();
            });


            // Panel actions (single-click) and selection (double-click) in Preview
            comicPreview.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-panel-btn');
                const framingBtn = e.target.closest('.toggle-framing-btn');
                const upscaleBtn = e.target.closest('.upscale-panel-btn, .upscale-overlay-btn');
                const upscaleChoiceBtn = e.target.closest('.upscale-choice-btn');

                if (upscaleChoiceBtn) {
                    e.stopPropagation();
                    const scale = parseInt(upscaleChoiceBtn.dataset.scale);
                    const isOverlay = upscaleChoiceBtn.dataset.type === 'overlay';
                    const panelEl = upscaleChoiceBtn.closest(isOverlay ? '.overlay-panel' : '.comic-panel');
                    const panelId = isOverlay ? panelEl.dataset.overlayPanelId : parseInt(panelEl.dataset.panelId);
                    
                    const collection = isOverlay ? project.pages[activePageIndex].overlayPanels : project.pages[activePageIndex].panels;
                    const panel = collection.find(p => p.id == panelId);

                    if (panel && panel.imageUrl) {
                        panelEl.classList.add('panel-generating');
                        const listCard = document.querySelector(`.panel-card[data-${isOverlay ? 'overlay-panel' : 'panel'}-id="${panel.id}"]`);
                        if (listCard) listCard.classList.add('panel-generating');
                        
                        upscaleChoiceBtn.closest('.upscale-options').classList.add('hidden');
                        
                        (async () => {
                            const newImageUrl = await upscaleImage(panel.imageUrl, scale);
                            if (newImageUrl) {
                                panel.imageUrl = newImageUrl;
                            } else {
                                alert(`No se pudo mejorar la imagen (x${scale}). Inténtalo de nuevo.`);
                            }
                            panel.isLoading = false; // Ensure isLoading is reset
                            if (panelEl) panelEl.classList.remove('panel-generating');
                            if (listCard) listCard.classList.remove('panel-generating');
                            updateAndSave();
                        })();
                    }
                    return; 
                }

                const popoverWasOpen = !document.querySelector('.framing-controls.hidden, .upscale-options.hidden');

                if (editBtn) {
                    comicPreview.querySelectorAll('.framing-controls, .upscale-options').forEach(el => el.classList.add('hidden'));
                    const id = parseInt(editBtn.dataset.panelId);
                    const panel = project.pages[activePageIndex].panels.find(p => p.id === id);
                    if (panel && panel.imageUrl) {
                        currentlyEditingPanelId = id; editedImageUrl = null;
                        const editImagePreview = getEl('edit-image-preview');
                        getEl('edit-prompt').value = ''; getEl('save-edit-btn').disabled = true;
                        const gallery = getEl('edit-panel-references-gallery'); gallery.innerHTML = '';
                        const characterRefs = panel.characterIds.map(id => project.characters.find(c => c.id === id)).filter(c => c && c.referenceImages && c.referenceImages.length > 0).flatMap(c => c.referenceImages);
                        if (characterRefs.length > 0) { characterRefs.forEach(imgSrc => { gallery.innerHTML += `<div class="aspect-square bg-gray-800 rounded-md overflow-hidden"><img src="${imgSrc}" class="w-full h-full object-cover"></div>`; }); }
                        else { gallery.innerHTML = '<p class="text-gray-500 text-xs col-span-2 text-center p-4">No hay imágenes de referencia para los personajes de esta viñeta.</p>'; }
                        editPanelModal.classList.remove('hidden'); editImagePreview.src = panel.imageUrl;
                        editImagePreview.onload = () => { if (cropper) cropper.destroy(); cropper = new Cropper(editImagePreview, { viewMode: 1, background: false, autoCropArea: 0.9 }); };
                    }
                } else if (framingBtn) {
                    const controls = framingBtn.closest('.comic-panel').querySelector('.framing-controls');
                    const wasHidden = controls.classList.contains('hidden');
                    comicPreview.querySelectorAll('.framing-controls, .upscale-options').forEach(el => el.classList.add('hidden'));
                    if (wasHidden) controls.classList.remove('hidden');
                } else if (upscaleBtn) {
                    const options = upscaleBtn.closest('.comic-panel, .overlay-panel').querySelector('.upscale-options');
                    const wasHidden = options.classList.contains('hidden');
                    comicPreview.querySelectorAll('.framing-controls, .upscale-options').forEach(el => el.classList.add('hidden'));
                    if (wasHidden) options.classList.remove('hidden');
                } else if (!e.target.closest('.comic-panel') && popoverWasOpen) {
                     comicPreview.querySelectorAll('.framing-controls, .upscale-options').forEach(el => el.classList.add('hidden'));
                }
            });
            
            comicPreview.addEventListener('dblclick', e => {
                const panelEl = e.target.closest('.comic-panel');
                // Ensure we're not double-clicking on a button, which should be handled by the single click listener
                if (panelEl && !e.target.closest('button')) {
                    selectedPanelId = parseInt(panelEl.dataset.panelId);
                    render(); // Re-render to show selection highlights

                    // After rendering, find the corresponding card in the side list and scroll it into view
                    const panelCardToScroll = panelsList.querySelector(`.panel-card[data-panel-id="${selectedPanelId}"]`);
                    if (panelCardToScroll) {
                        panelCardToScroll.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            });

            comicPreview.addEventListener('input', e => {
                const slider = e.target;
                const controls = slider.closest('.framing-controls');
                if (!controls) return;
                const panelId = parseInt(controls.dataset.panelId);
                const panel = project.pages[activePageIndex].panels.find(p => p.id === panelId);
                if (!panel) return;
                if (!panel.transform) panel.transform = { zoom: 1, panX: 50, panY: 50 };
                const img = comicPreview.querySelector(`[data-panel-id="${panel.id}"] img`);

                if (slider.classList.contains('zoom-slider')) {
                    panel.transform.zoom = parseFloat(slider.value);
                } else if (slider.classList.contains('pan-x-slider')) {
                    panel.transform.panX = parseInt(slider.value);
                } else if (slider.classList.contains('pan-y-slider')) {
                    panel.transform.panY = parseInt(slider.value);
                }
                
                if (img) {
                    img.style.transformOrigin = `${panel.transform.panX}% ${panel.transform.panY}%`;
                    img.style.transform = `scale(${panel.transform.zoom})`;
                }
                debouncedAutosave();
            });

            // Panel list textareas and checkboxes
            panelsList.addEventListener('input', e => {
                const target = e.target;
                const panelCard = target.closest('.panel-card');
                if (!panelCard) return;
                const panelId = parseInt(panelCard.dataset.panelId);
                const panel = project.pages[activePageIndex].panels.find(p => p.id === panelId);
                if (!panel) return;

                if (target.classList.contains('panel-prompt')) {
                    panel.prompt = target.value;
                } else if (target.classList.contains('ref-prev-checkbox')) {
                    panel.usePreviousAsRef = target.checked;
                }
                debouncedAutosave();
            });
            
             // Double-click panel in list to scroll to it in preview
            panelsList.addEventListener('dblclick', e => {
                const panelCard = e.target.closest('.panel-card');
                if (panelCard) {
                    const panelId = panelCard.dataset.panelId;
                    const panelInPreview = comicPreview.querySelector(`.comic-panel[data-panel-id="${panelId}"]`);
                    if (panelInPreview) {
                        panelInPreview.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });

             overlayPanelsList.addEventListener('input', e => {
                const target = e.target;
                const panelCard = target.closest('.panel-card');
                if (!panelCard) return;
                const panelId = panelCard.dataset.overlayPanelId;
                const panel = project.pages[activePageIndex].overlayPanels.find(p => p.id === panelId);
                if (!panel) return;

                if (target.classList.contains('overlay-panel-prompt')) {
                    panel.prompt = target.value;
                }
                debouncedAutosave();
            });

            // Panel drag and drop reordering
            let draggedPanelId = null;
            let placeholder = null;
            let draggedElementHeight = 0;

            function createPlaceholder() {
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'drop-placeholder';
                }
                return placeholder;
            }

            panelsList.addEventListener('dragstart', e => {
                const panelCard = e.target.closest('.panel-card');
                if (panelCard) {
                    draggedPanelId = parseInt(panelCard.dataset.panelId);
                    draggedElementHeight = panelCard.offsetHeight;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => {
                        panelCard.classList.add('dragging');
                    }, 0);
                }
            });

            panelsList.addEventListener('dragend', e => {
                document.querySelectorAll('.panel-card.dragging').forEach(el => el.classList.remove('dragging'));
                if (placeholder && placeholder.parentElement) {
                    placeholder.parentElement.removeChild(placeholder);
                }
                placeholder = null;
                draggedPanelId = null;
            });

            panelsList.addEventListener('dragover', e => {
                e.preventDefault();
                const ph = createPlaceholder();
                ph.style.height = `${draggedElementHeight}px`;

                const targetCard = e.target.closest('.panel-card:not(.dragging)');
                if (targetCard) {
                    const rect = targetCard.getBoundingClientRect();
                    const isAfter = (e.clientY - rect.top) / rect.height > 0.5;
                    if (isAfter) {
                        targetCard.parentNode.insertBefore(ph, targetCard.nextSibling);
                    } else {
                        targetCard.parentNode.insertBefore(ph, targetCard);
                    }
                } else if (!panelsList.querySelector('.drop-placeholder')) {
                    panelsList.appendChild(ph);
                }
            });

            panelsList.addEventListener('drop', e => {
                e.preventDefault();
                const draggedElement = panelsList.querySelector('.dragging');
                if (placeholder && placeholder.parentElement && draggedElement) {
                    placeholder.parentNode.replaceChild(draggedElement, placeholder);
                    
                    const newOrder = Array.from(panelsList.querySelectorAll('.panel-card')).map(card =>
                        project.pages[activePageIndex].panels.find(p => p.id === parseInt(card.dataset.panelId))
                    ).filter(Boolean);
                    
                    project.pages[activePageIndex].panels = newOrder;
                    
                    updateAndSave();
                }
            });

            addPanelBtn.addEventListener('click', () => {
                project.pages[activePageIndex].panels.push({
                    id: nextId.panel++, prompt: '', characterIds: [], backgroundId: null, clothingIds: [], poseIds: [],
                    imageUrl: null, isLoading: false, shape: 'rectangle', size: 1, usePreviousAsRef: false,
                    transform: { zoom: 1, panX: 50, panY: 50 }
                });
                updateAndSave();
                panelsList.scrollTop = panelsList.scrollHeight;
            });
            
            getEl('add-overlay-panel-btn').addEventListener('click', () => {
                const overlayPanels = project.pages[activePageIndex].overlayPanels;
                overlayPanels.push({
                    id: 'o' + nextId.overlayPanel++, prompt: '', imageUrl: null, shape: 'rectangle', 
                    x: 10, y: 10, width: 200, height: 150, opacity: 1,
                    zIndex: (overlayPanels.length + 1) * 20, isLoading: false
                });
                updateAndSave();
                overlayPanelsList.scrollTop = overlayPanelsList.scrollHeight;
            });

            pageBgColorPicker.addEventListener('input', e => {
                project.pages[activePageIndex].backgroundColor = e.target.value;
                comicPreviewContainer.style.backgroundColor = e.target.value;
                debouncedAutosave();
            });
            
            // Tab switching
            getEl('tab-creation').addEventListener('click', () => { getEl('creation-panel').classList.remove('hidden'); getEl('script-panel').classList.add('hidden'); getEl('tab-creation').classList.add('active'); getEl('tab-script').classList.remove('active'); });
            getEl('tab-script').addEventListener('click', () => { getEl('creation-panel').classList.add('hidden'); getEl('script-panel').classList.remove('hidden'); getEl('tab-creation').remove('active'); getEl('tab-script').classList.add('active'); });
            
            // File Menu
            getEl('file-menu-btn').addEventListener('click', () => getEl('file-dropdown').classList.toggle('hidden'));
            getEl('save-project-btn').addEventListener('click', autosaveProject);
            getEl('backup-project-btn').addEventListener('click', saveProjectToFile);
            getEl('load-project-btn').addEventListener('click', () => getEl('load-project-input').click());
            getEl('load-project-input').addEventListener('change', loadProject);
            
            // Script import
            getEl('import-script-btn').addEventListener('click', importScript);

            // Auto Layout
            autoLayoutBtn.addEventListener('click', () => layoutPopover.classList.toggle('hidden'));
            layoutPopover.addEventListener('click', e => {
                const btn = e.target.closest('.layout-option-btn');
                if (btn) {
                    project.pages[activePageIndex].layout = btn.dataset.layout;
                    updateAndSave();
                }
            });

            // Presentation Mode
            getEl('presentation-mode-btn').addEventListener('click', () => {
                document.body.classList.toggle('presentation-mode');
                if (document.body.classList.contains('presentation-mode')) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                }
            });
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    document.body.classList.remove('presentation-mode');
                }
            });

            // Export/Download Buttons
            downloadComicBtn.addEventListener('click', async () => {
                 unselectTextElement();
                 selectedPanelId = null;
                 selectedOverlayPanelId = null;
                 renderPreview();
                 await new Promise(resolve => setTimeout(resolve, 100));

                 showExportLoader('Preparando imagen para descarga...');
                 const container = comicPreviewContainer;
                 const mainContent = getEl('main-content');
                 
                 const originalContainerStyle = { overflow: container.style.overflow, height: container.style.height };
                 const originalMainStyle = { height: mainContent.style.height };
                 
                 container.style.overflow = 'visible';
                 container.style.height = 'auto';
                 mainContent.style.height = 'auto';
                 
                 await new Promise(resolve => setTimeout(resolve, 100));

                 try {
                     const canvas = await html2canvas(container, {
                        backgroundColor: project.pages[activePageIndex].backgroundColor,
                        scale: 1.5,
                        useCORS: true,
                     });
                     
                     const link = document.createElement('a');
                     link.download = `comic-page-${activePageIndex + 1}.png`;
                     link.href = canvas.toDataURL('image/png');
                     link.click();
                 } catch (error) {
                     console.error("Error during single page export:", error);
                     alert("Ocurrió un error al exportar la imagen. El contenido puede ser demasiado grande.");
                 } finally {
                     container.style.overflow = originalContainerStyle.overflow;
                     container.style.height = originalContainerStyle.height;
                     mainContent.style.height = originalMainStyle.height;
                     hideExportLoader();
                 }
            });
            
            downloadPanelsBtn.addEventListener('click', async () => {
                const zip = new JSZip();
                const panelsWithImages = project.pages[activePageIndex].panels.filter(p => p.imageUrl);
                if(panelsWithImages.length === 0) return alert('No hay viñetas con imágenes para descargar.');
                
                for (let i = 0; i < panelsWithImages.length; i++) {
                    const panel = panelsWithImages[i];
                    const response = await fetch(panel.imageUrl);
                    const blob = await response.blob();
                    zip.file(`panel_${activePageIndex + 1}_${i + 1}.png`, blob);
                }

                zip.generateAsync({ type: "blob" }).then(content => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `comic_page_${activePageIndex + 1}_panels.zip`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                });
            });

            downloadAllPagesBtn.addEventListener('click', async () => {
                if (project.pages.length === 0) return alert("No hay páginas para exportar.");
                showExportLoader('Preparando exportación a ZIP...');
                const zip = new JSZip();
                const originalPageIndex = activePageIndex;
                const container = comicPreviewContainer;
                const mainContent = getEl('main-content');
                
                const originalContainerStyle = { overflow: container.style.overflow, height: container.style.height };
                const originalMainStyle = { height: mainContent.style.height };

                container.style.overflow = 'visible';
                container.style.height = 'auto';
                mainContent.style.height = 'auto';

                try {
                    for (let i = 0; i < project.pages.length; i++) {
                        showExportLoader(`Procesando página ${i + 1} de ${project.pages.length}...`);
                        activePageIndex = i;
                        renderPreview();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const canvas = await html2canvas(container, { 
                            backgroundColor: project.pages[i].backgroundColor, 
                            scale: 1.5,
                            useCORS: true
                        });
                        const imageData = canvas.toDataURL('image/png').split(',')[1];
                        zip.file(`pagina_${i + 1}.png`, imageData, { base64: true });
                    }

                    showExportLoader('Generando archivo ZIP...');
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `mi_comic_completo.zip`;
                    link.click();
                    URL.revokeObjectURL(link.href);

                } catch (error) {
                    console.error("Error during ZIP export:", error);
                    alert("Ocurrió un error al exportar las páginas. Alguna página puede ser demasiado grande.");
                } finally {
                    container.style.overflow = originalContainerStyle.overflow;
                    container.style.height = originalContainerStyle.height;
                    mainContent.style.height = originalMainStyle.height;
                    activePageIndex = originalPageIndex;
                    render();
                    hideExportLoader();
                }
            });

            getEl('export-pdf-btn').addEventListener('click', async () => {
                if (project.pages.length === 0) return alert("No hay páginas para exportar.");
                showExportLoader('Preparando exportación a PDF...');
                const originalPageIndex = activePageIndex;
                const container = comicPreviewContainer;
                const mainContent = getEl('main-content');
                let pdf = null;
                
                const originalContainerStyle = { overflow: container.style.overflow, height: container.style.height };
                const originalMainStyle = { height: mainContent.style.height };

                container.style.overflow = 'visible';
                container.style.height = 'auto';
                mainContent.style.height = 'auto';

                try {
                    for (let i = 0; i < project.pages.length; i++) {
                        showExportLoader(`Procesando página ${i + 1} de ${project.pages.length} para PDF...`);
                        activePageIndex = i;
                        renderPreview();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const canvas = await html2canvas(container, { 
                            backgroundColor: project.pages[i].backgroundColor,
                            scale: 1.5,
                            useCORS: true
                        });
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;

                        if (i === 0) {
                            pdf = new jsPDF({ orientation: imgWidth > imgHeight ? 'l' : 'p', unit: 'px', format: [imgWidth, imgHeight] });
                        } else {
                            pdf.addPage([imgWidth, imgHeight], imgWidth > imgHeight ? 'l' : 'p');
                        }
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    }

                    if (pdf) {
                       pdf.save('mi-comic.pdf');
                    }
                } catch (error) {
                    console.error("Error during PDF export:", error);
                    alert("Ocurrió un error al exportar a PDF. Alguna página puede ser demasiado grande.");
                } finally {
                    container.style.overflow = originalContainerStyle.overflow;
                    container.style.height = originalContainerStyle.height;
                    mainContent.style.height = originalMainStyle.height;
                    activePageIndex = originalPageIndex;
                    render();
                    hideExportLoader();
                }
            });
            
            getEl('export-webtoon-btn').addEventListener('click', async () => {
                if (project.pages.length === 0) return alert("No hay páginas para exportar.");
                showExportLoader('Preparando exportación para Webtoon...');
                const zip = new JSZip();
                const originalPageIndex = activePageIndex;
                const MAX_HEIGHT = 1280;
                const container = comicPreviewContainer;
                const mainContent = getEl('main-content');
                
                const originalContainerStyle = { overflow: container.style.overflow, height: container.style.height };
                const originalMainStyle = { height: mainContent.style.height };
                
                container.style.overflow = 'visible';
                container.style.height = 'auto';
                mainContent.style.height = 'auto';

                try {
                    for (let i = 0; i < project.pages.length; i++) {
                        showExportLoader(`Procesando página ${i + 1} de ${project.pages.length} para Webtoon...`);
                        activePageIndex = i;
                        renderPreview();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const canvas = await html2canvas(container, {
                            backgroundColor: project.pages[i].backgroundColor,
                            scale: 1.5,
                            useCORS: true
                        });
                        
                        const totalHeight = canvas.height;
                        let y = 0;
                        let sliceNumber = 1;

                        while (y < totalHeight) {
                            const sliceHeight = Math.min(MAX_HEIGHT, totalHeight - y);
                            if (sliceHeight <= 0) break;
                            const sliceCanvas = document.createElement('canvas');
                            sliceCanvas.width = canvas.width;
                            sliceCanvas.height = sliceHeight;
                            const ctx = sliceCanvas.getContext('2d');
                            if (!ctx) continue;
                            ctx.drawImage(canvas, 0, y, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
                            
                            const imageData = sliceCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                            zip.file(`pagina_${i + 1}_slice_${sliceNumber++}.jpg`, imageData, { base64: true });
                            y += MAX_HEIGHT;
                        }
                    }
                    
                    showExportLoader('Generando archivo ZIP para Webtoon...');
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `mi_webtoon.zip`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } catch (error) {
                     console.error("Error during Webtoon export:", error);
                    alert("Ocurrió un error al exportar para Webtoon. Alguna página puede ser demasiado grande.");
                } finally {
                    container.style.overflow = originalContainerStyle.overflow;
                    container.style.height = originalContainerStyle.height;
                    mainContent.style.height = originalMainStyle.height;
                    activePageIndex = originalPageIndex;
                    render();
                    hideExportLoader();
                }
            });


            // --- INIT ---
            checkForAutosave();
            render();
        });
    </script>
</body>
</html>